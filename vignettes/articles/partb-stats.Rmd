---
title: "Provider Analysis"
output: html_document
---

```{r include = FALSE}
knitr::opts_chunk$set(
  collapse  = TRUE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 300, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)
```

```{r message=FALSE, warning=FALSE}
library(provider)
library(tidyverse)
library(gt)
```


## Provider Utilization Summary

```{r}
df <- map_dfr(pop_years(), ~by_provider(year = .x, npi = 1023076643))
```

<br>

```{r}
select(df, year, entity_type, specialty, city:state, ruca, tot_hcpcs:tot_std_pymt) |>
  gt_preview(top_n = 10) |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  fmt_currency(columns = c(tot_charges, tot_allowed, tot_payment, tot_std_pymt), decimals = 2)
```

<br>

```{r}
select(df, year, demographics) |> 
  unnest(demographics) |>
  gt_preview(top_n = 10) |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  sub_missing()
```

<br>

```{r}
select(df, year, hcc_risk_avg, conditions) |> 
  unnest(conditions) |>
  gt_preview(top_n = 10) |> 
  fmt_percent(columns = starts_with("cc_"), decimals = 0) |>
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  sub_missing()
```

<br><br>

### Counts & Amounts

```{r}
select(df, year, starts_with("tot_")) |> 
  select(-tot_hcpcs, -tot_std_pymt) |> 
  change(starts_with("tot_")) |> 
  gt(rowname_col = "year") |> 
  fmt_integer(columns = c(tot_benes, 
                          tot_srvcs, 
                          tot_benes_chg, 
                          tot_srvcs_chg)) |> 
  fmt_currency(columns = c(tot_charges, 
                           tot_allowed, 
                           tot_payment, 
                           tot_charges_chg, 
                           tot_allowed_chg, 
                           tot_payment_chg, 
                           tot_charges_chg_cum, 
                           tot_allowed_chg_cum, 
                           tot_payment_chg_cum), decimals = 0, suffixing = TRUE) |> 
  fmt_percent(columns = contains("pct"), decimals = 0, force_sign = TRUE) |>
  sub_zero(zero_text = "") |> 
  grand_summary_rows(columns = c(tot_benes, 
                                 tot_srvcs, 
                                 tot_benes_chg, 
                                 tot_srvcs_chg),
                     fns =  list(label = md("**Avg**"), 
                                 id = "average", fn = "mean"),
                     fmt = ~ fmt_integer(.), 
                     missing_text = "") |> 
  grand_summary_rows(columns = c(tot_charges, 
                                 tot_allowed, 
                                 tot_payment, 
                           tot_charges_chg, 
                           tot_allowed_chg, 
                           tot_payment_chg, 
                           tot_charges_chg_cum, 
                           tot_allowed_chg_cum, 
                           tot_payment_chg_cum),
                     fns =  list(label = md("**Avg**"), 
                                 id = "average", fn = "mean"),
                     fmt = ~ fmt_currency(., decimals = 0, suffixing = TRUE), 
                     missing_text = "") |> 
  tab_spanner(label = "Beneficiaries",columns = contains("bene")) |> 
  tab_spanner(label = "Services", columns = contains("srvcs")) |> 
  tab_spanner(label = "Submitted Charges", columns = contains("charges")) |> 
  tab_spanner(label = "Amount Allowed", columns = contains("allowed")) |> 
  tab_spanner(label = "Net Payment", columns = contains("payment")) |> 
  cols_label(
    tot_benes = ("Tot"),
    tot_benes_chg = ("YOY"),
    tot_benes_chg_cum = ("Cum"),
    tot_benes_pct = ("Pct"),
    tot_benes_pct_cum = ("Cum"),
    tot_srvcs = ("Tot"),
    tot_srvcs_chg = ("YOY"),
    tot_srvcs_chg_cum = ("Cum"),
    tot_srvcs_pct = ("Pct"),
    tot_srvcs_pct_cum = ("Cum"),
    tot_charges = ("Tot"),
    tot_charges_chg = ("YOY"),
    tot_charges_chg_cum = ("Cum"),
    tot_charges_pct = ("Pct"),
    tot_charges_pct_cum = ("Cum"),
    tot_allowed = ("Tot"),
    tot_allowed_chg = ("YOY"),
    tot_allowed_chg_cum = ("Cum"),
    tot_allowed_pct = ("Pct"),
    tot_allowed_pct_cum = ("Cum"),
    tot_payment = ("Tot"),
    tot_payment_chg = ("YOY"),
    tot_payment_chg_cum = ("Cum"),
    tot_payment_pct = ("Pct"),
    tot_payment_pct_cum = ("Cum")
    ) |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |>
  tab_header(title = md("**Medicare Part B** Utilization"),
             subtitle = md("Counts & Amounts, 2013-2019")) |> 
  data_color(columns = c(tot_benes, tot_srvcs, tot_charges, tot_allowed, tot_payment),
             method = "numeric",
             palette = "Reds") |> 
  data_color(columns = c(tot_benes_chg, tot_benes_chg_cum, tot_benes_pct, tot_benes_pct_cum),
             rows = tot_benes_chg < 0,
             method = "numeric",
             palette = "red", 
             apply_to = "text") |> 
  data_color(columns = c(tot_benes_chg, tot_benes_chg_cum, tot_benes_pct, tot_benes_pct_cum),
             rows = tot_benes_chg > 0,
             method = "numeric",
             palette = "gray50", 
             apply_to = "text") |> 
  data_color(columns = c(tot_srvcs_chg, tot_srvcs_chg_cum, tot_srvcs_pct, tot_srvcs_pct_cum),
             rows = tot_srvcs_chg < 0,
             method = "numeric",
             palette = "red", 
             apply_to = "text") |> 
  data_color(columns = c(tot_srvcs_chg, tot_srvcs_chg_cum, tot_srvcs_pct, tot_srvcs_pct_cum),
             rows = tot_srvcs_chg > 0,
             method = "numeric",
             palette = "gray50", 
             apply_to = "text") |> 
  tab_options(table.width = pct(100),
              column_labels.font.weight = "bold",
              row_group.font.weight = "bold",
              heading.background.color = "black",
              heading.align = "left")
```

<br>

### Year-Over-Year Percentage Change

```{r}
select(df, 
       year, 
       Beneficiaries = tot_benes,
       Services = tot_srvcs,
       Payment = tot_payment) |> 
  change(c(Beneficiaries, Services, Payment)) |> 
  select(-contains(c("_chg", "_cum"))) |> 
  gt(rowname_col = "year") |> 
  grand_summary_rows(columns = c(Beneficiaries, Services),
                     fns =  list(label = md("**AVERAGES**"), 
                                 id = "average", fn = "mean"),
                     fmt = ~ fmt_integer(.)) |> 
  grand_summary_rows(columns = c(Payment),
                     fns =  list(label = md("**AVERAGES**"), 
                                 id = "average", fn = "mean"),
                     fmt = ~ fmt_currency(., decimals = 0)) |>
  fmt_percent(columns = contains("_pct"), decimals = 0, force_sign = TRUE) |> 
  fmt_integer(columns = c(Beneficiaries, Services)) |> 
  fmt_currency(columns = c(Payment), decimals = 0) |> 
  cols_merge_n_pct(Beneficiaries, Beneficiaries_pct) |> 
  cols_merge_n_pct(Services, Services_pct) |>
  cols_merge_n_pct(Payment, Payment_pct) |>
  opt_table_font(font = google_font(name = "JetBrains Mono")) |>
  tab_header(title = md("**Medicare Part B** Utilization"),
             subtitle = md("Year-Over-Year Percentage Changes, 2013-2019")) |> 
  tab_options(table.width = pct(75),
              column_labels.font.weight = "bold",
              row_group.font.weight = "bold",
              heading.background.color = "black",
              heading.align = "left")
```

<br>

### Trends

```{r}
select(df, 
       year, 
       HCPCS = tot_hcpcs,
       Beneficiaries = tot_benes,
       Services = tot_srvcs,
       Charges = tot_charges,
       Allowed = tot_allowed,
       Payment = tot_payment) |> 
  pivot_longer(cols = c(HCPCS, 
                        Beneficiaries, 
                        Services, 
                        Charges, 
                        Allowed, 
                        Payment), 
               names_to = "Type", 
               values_to = "Amount") |> 
  pivot_wider(names_from = year, 
              values_from = Amount) |> 
  gt(rowname_col = "Type") |> 
  tab_stubhead(label = md("**Measures**")) |>
  cols_hide(columns = matches("2014|2015|2016|2017|2018")) |>
  cols_nanoplot(
    columns = contains("20"),
    new_col_name = "nanoplots",
    new_col_label = md("*TREND*"),
    reference_line = "mean",
    plot_height = "3em",
    options = nanoplot_options(
      data_line_stroke_color = "black",
      show_reference_line = TRUE,
      show_reference_area = FALSE)) |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |>
  tab_header(title = md("**Medicare Part B** Utilization"),
             subtitle = md("Trends, 2013-2019")) |> 
  opt_horizontal_padding(scale = 2) |> 
  tab_options(table.width = pct(50),
              column_labels.font.weight = "bold",
              row_group.font.weight = "bold",
              heading.background.color = "black",
              heading.align = "left")
```

<br>

### Chronic Condition Prevalence

```{r}
chronic <- compare_conditions(df)

chronic
```

<br>

```{r}
gt(chronic) |> 
  cols_nanoplot(
    columns = contains("Provider"),
    reference_line = "mean",
    new_col_name = "provider_plot",
    new_col_label = md("*Provider*"),
    missing_vals = "remove",
    plot_height = "3em",
    options = nanoplot_options(
      data_line_stroke_color = "black",
      show_reference_line = TRUE,
      show_reference_area = FALSE)) |> 
  cols_nanoplot(
    columns = contains("State"),
    reference_line = "mean",
    new_col_name = "state_plot",
    new_col_label = md("*State*"),
    missing_vals = "remove",
    plot_height = "3em",
    options = nanoplot_options(
      data_line_stroke_color = "black",
      show_reference_line = TRUE,
      show_reference_area = FALSE)) |> 
  cols_nanoplot(
    columns = contains("National"),
    reference_line = "mean",
    new_col_name = "national_plot",
    new_col_label = md("*National*"),
    missing_vals = "remove",
    plot_height = "3em",
    options = nanoplot_options(
      data_line_stroke_color = "black",
      show_reference_line = TRUE,
      show_reference_area = FALSE)) |> 
  cols_hide(columns = contains("20")) |>
  opt_table_font(font = google_font(name = "JetBrains Mono")) |>
  tab_header(title = md("**Medicare Part B** Utilization"),
             subtitle = md("**Chronic Conditions Prevalence** Comparison, 2013-2018")) |> 
  opt_horizontal_padding(scale = 2) |> 
  tab_options(table.width = pct(50),
              column_labels.font.weight = "bold",
              row_group.font.weight = "bold",
              heading.background.color = "black",
              heading.align = "left")
```


<br>

## HCPCS Utilization Data

```{r}
srvc <- map_dfr(pop_years(), ~by_service(year = .x, npi = 1023076643))

srvc
```

<br>

```{r}
hcpcs <- compare_hcpcs(srvc)

hcpcs
```



<br><br>

```{r}
hcpcs |> 
  group_by(year, level, family) |>
  summarise(Beneficiaries = sum(beneficiaries),
            Services = sum(services),
            "Average Payment" = mean(avg_payment), .groups = "drop") |>
  arrange(year, family) |>
  gt() |> 
  fmt_integer(columns = c(Beneficiaries, Services)) |> 
  fmt_currency(columns = c('Average Payment'), decimals = 2) |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |>
  tab_header(title = md("**Medicare Part B** Utilization")) |> 
  opt_horizontal_padding(scale = 2) |> 
  tab_options(table.width = pct(50),
              column_labels.font.weight = "bold",
              row_group.font.weight = "bold",
              heading.background.color = "black",
              heading.align = "left")
```


<br><br>

```{r}
hcpcs |>
select(year, 
         level, 
         HCPCS = hcpcs_code,
         beneficiaries,
         services, 
         "Average Payment" = avg_payment) |> 
  mutate("Services Per Beneficiary" = services/beneficiaries) |> 
  select(-c(beneficiaries, services)) |> 
  pivot_longer(!year:HCPCS, 
               names_to = "stat", 
               values_to = "amount") |> 
  pivot_wider(names_from = level, 
              values_from = amount) |> 
  arrange(stat, HCPCS) |>
  filter(stat %in% c("Average Payment")) |> 
  gt(rowname_col = "year") |> 
  fmt_currency(columns = c(Provider, State, National), decimals = 2) |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |>
  tab_header(title = md("**Average Payment** By HCPCS")) |> 
  cols_hide(stat) |> 
  data_color(columns = c(Provider, State, National),
             direction = "row",
             method = "numeric",
             palette = "Reds") |> 
  tab_options(table.width = pct(75),
              column_labels.font.weight = "bold",
              row_group.font.weight = "bold",
              heading.background.color = "black",
              heading.align = "left")
```
<br><br>

```{r}
hcpcs |>
select(year, 
         level, 
         HCPCS = hcpcs_code,
         beneficiaries,
         services, 
         "Average Payment" = avg_payment) |> 
  mutate("Services Per Beneficiary" = services/beneficiaries) |> 
  select(-c(beneficiaries, services)) |> 
  pivot_longer(!year:HCPCS, 
               names_to = "stat", 
               values_to = "amount") |> 
  pivot_wider(names_from = level, 
              values_from = amount) |> 
  arrange(stat, HCPCS) |> 
  filter(stat %in% c("Services Per Beneficiary")) |> 
  gt(rowname_col = "year") |> 
  fmt_number(columns = c(Provider, State, National), decimals = 2) |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |>
  tab_header(title = md("**Services Per Beneficiary** By HCPCS")) |> 
  cols_hide(stat) |> 
  data_color(columns = c(Provider, State, National),
             direction = "row",
             method = "numeric",
             palette = "Reds") |> 
  tab_options(table.width = pct(75),
              column_labels.font.weight = "bold",
              row_group.font.weight = "bold",
              heading.background.color = "black",
              heading.align = "left")
```

<br>
