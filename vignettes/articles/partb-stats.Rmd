---
title: "provider for Analysis"
description: "Demographics, Patient Mix, and Performance"
author: "Andrew Bruce"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 600, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)
options(scipen = 999)
```

```{r message=FALSE, warning=FALSE}
library(provider)
library(tidyverse)
library(gt)
library(gtExtras)
library(tictoc)
```



## `utilization()`


```{r}
tic()
ind     <- map_dfr(util_years(), ~utilization(year = .x, npi = 1043477615, type = "provider"))
srvc    <- map_dfr(util_years(), ~utilization(year = .x, npi = 1023076643, type = "service"))
chronic <- compare_conditions(ind)
hcpcs   <- compare_hcpcs(srvc)
toc()

## 292.17 sec elapsed
## 4.8695 min
```



<br>

### Provider Performance Data

```{r}
ind |> 
  unnest(performance) |> 
  select(year, tot_hcpcs:.pymt_per_srvc)
```


### Beneficiary Demographics

```{r}
ind |> 
  unnest(performance, demographics) |> 
  select(year, tot_benes, starts_with("bene_")) |> 
  gt(rowname_col = "year") |> 
  cols_label(tot_benes = "Total") |>  
  fmt_percent(columns = starts_with("cc_"), decimals = 0) |>
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  sub_missing(missing_text = "") |>
  sub_zero(zero_text = "") |>
  opt_all_caps()
```


### Beneficiary Chronic Conditions Data

```{r}
ind |> 
  unnest(performance) |> 
  select(year, tot_benes, conditions) |> 
  unnest(conditions) |>
  gt(rowname_col = "year") |> 
  cols_label(tot_benes = "Total") |>  
  fmt_percent(columns = starts_with("cc_"), decimals = 0) |>
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  sub_missing(missing_text = "") |>
  sub_zero(zero_text = "") |>
  opt_all_caps()
```


<br>

### Chronic Condition Prevalence


```{r}
chronic |>
  # filter(prevalence > 0)
  # filter(!if_any(contains("20"), ~ . <= 0)) |>
  pivot_wider(names_from = year, 
              values_from = prevalence) |>
  gt(rowname_col = "level") |> 
  fmt_percent(columns = contains('0'), decimals = 0) |>
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  sub_missing(missing_text = "") |> 
  cols_nanoplot(
    columns = starts_with("20"),
    plot_type = "bar",
    new_col_name = "change",
    new_col_label = "change",
    missing_vals = "remove",
    options = nanoplot_options(
      show_data_line = FALSE,
      show_data_area = FALSE,
      data_bar_stroke_color = "transparent"
    )
  )
```


<br>

## HCPCS Utilization Data

```{r}
srvc |> 
  dplyr::group_by(year, family) |> 
  dplyr::mutate(hcpcs_level = dplyr::min_rank(dplyr::pick(avg_allowed, avg_payment))) |> 
  dplyr::select(year, hcpcs_code, family, hcpcs_level, avg_allowed, avg_payment) |> 
  gt_preview(top_n = 30) |> 
  opt_table_font(font = google_font(name = "Fira Code")) |> 
  fmt_currency(columns = starts_with("avg_"), decimals = 0)
```

<br>

```{r}
srvc |> 
  select(year, 
         hcpcs_code, 
         family, 
         tot_benes, 
         tot_srvcs, 
         avg_charge, 
         avg_allowed, 
         avg_payment) |> 
  group_by(year, family) |> 
  summarise(tot_benes = sum(tot_benes),
            tot_srvcs = sum(tot_srvcs),
            avg_charge = mean(avg_charge), 
            avg_allowed = mean(avg_allowed), 
            avg_payment = mean(avg_payment), .groups = "drop") |>
  arrange(family) |> 
  gt(rowname_col = "year") |> 
  fmt_currency(columns = starts_with("avg_"), decimals = 0) |>
  cols_label(
    tot_benes = "Beneficiaries",
    tot_srvcs = "Services",
    avg_charge = "Charge",
    avg_allowed= "Allowed",
    avg_payment = "Payment") |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  opt_all_caps()
```

<br>
<br>


```{r}
hcpcs |> 
  select(year, 
         level,
         hcpcs_code,
         category,
         subcategory,
         family, 
         beneficiaries, 
         services, 
         avg_charge, 
         avg_allowed, 
         avg_payment) |> 
  arrange(hcpcs_code, year) |>
  gt(rowname_col = "year") |> 
  cols_label(
    hcpcs_code = "HCPCS",
    avg_charge = "Charge",
    avg_allowed= "Allowed",
    avg_payment = "Payment") |> 
  cols_align(columns = "level", align = "left") |>
  fmt_integer(columns = c(beneficiaries, services)) |>
  fmt_currency(columns = starts_with("avg_"), decimals = 0) |>
  opt_table_font(font = google_font(name = "JetBrains Mono")) |> 
  opt_all_caps()
```



<br>
<br>

```{r}
hcpcs |> 
  group_by(year, level, category) |>
  summarise(Beneficiaries = sum(beneficiaries),
            Services = sum(services),
            "Average Payment" = mean(avg_payment), .groups = "drop") |>
  arrange(year, category) |>
  gt(rowname_col = "year") |> 
  cols_align("left", level) |> 
  cols_move_to_start(columns = category) |> 
  fmt_integer(columns = c(Beneficiaries, Services)) |> 
  fmt_currency(columns = c('Average Payment'), decimals = 2) |> 
  opt_table_font(font = google_font(name = "JetBrains Mono")) |>
  tab_header(title = md("**Medicare Part B** Utilization")) |> 
  opt_horizontal_padding(scale = 2) |> 
  tab_options(table.width = pct(50),
              column_labels.font.weight = "bold",
              row_group.font.weight = "bold",
              heading.background.color = "black",
              heading.align = "left") |> 
  opt_all_caps()
```

<br><br>
