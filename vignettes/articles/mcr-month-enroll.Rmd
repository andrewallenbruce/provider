---
title: "Medicare Monthly Enrollment API"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = TRUE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 300, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)
options(scipen = 999)
options(knitr.table.format = "html")
```

```{r}
library(provider)
```

<br>

> *Current information on the number of Medicare beneficiaries with hospital/medical coverage and prescription drug coverage, available for several geographical areas.*

<br>

The Medicare Monthly Enrollment data provides current monthly information on the number of Medicare beneficiaries with hospital/medical coverage and prescription drug coverage, available for several geographic areas including national, state/territory, and county. The hospital/medical coverage data can be broken down further by health care delivery (Original Medicare versus Medicare Advantage and Other Health Plans) and the prescription drug coverage data can be examined by those enrolled in stand-alone Prescription Drug Plans and those enrolled in Medicare Advantage Prescription Drug plans. The dataset includes enrollee counts on a rolling 12 month basis and also provides information on yearly trends. The dataset is based on information gathered from CMS administrative enrollment data for beneficiaries enrolled in the Medicare program available from the CMS Chronic Conditions Data Warehouse.

<br>

## Examples

```{r}
national <- beneficiary_enrollment(level = "National")

yr_nat_list <- national |> 
  dplyr::filter(month == "Year") |> 
  dplyr::select(year, bene_orig, bene_ma_oth) |> 
  dplyr::mutate(pct_orig = bene_orig / (bene_orig + bene_ma_oth),
                pct_ma = bene_ma_oth / (bene_orig + bene_ma_oth)) |> 
  tidyr::pivot_longer(cols = c(pct_orig, pct_ma), 
                      names_to = "measure", 
                      values_to = "pct") |> 
  dplyr::group_by(year) |> 
  dplyr::summarise(list_data = list(pct), .groups = "drop")

yr_nat_base <- national |> 
  dplyr::filter(month == "Year") |> 
  dplyr::select(year, bene_total) |> 
  dplyr::mutate(bene_roll_avg = slider::slide_mean(bene_total, before = 1)) |> 
  change_abs(bene_total, year) |> 
  change_pct(bene_total, bene_total_chg, year) |> 
  dplyr::relocate(bene_roll_avg, .after = bene_total)

dplyr::left_join(yr_nat_base, 
                 yr_nat_list, 
                 by = dplyr::join_by(year)) |>   
  gt::gt() |> 
  gt::fmt_number(columns = c(bene_total, 
                             bene_roll_avg), 
                             decimals = 0) |> 
  gt::fmt_number(columns = c(bene_total_chg), 
                 decimals = 0, 
                 force_sign = TRUE) |> 
  gt::fmt_percent(columns = bene_total_pct, 
                  decimals = 2, 
                  force_sign = TRUE) |> 
  gt::sub_missing(columns = dplyr::everything(), 
                  missing_text = "--") |> 
  gt::cols_merge_n_pct(col_n = bene_total_chg, 
                       col_pct = bene_total_pct) |> 
  gt::cols_label(bene_total = "Total", 
                 bene_roll_avg = "Rolling Mean", 
                 bene_total_chg = "Yearly Change") |> 
  gtExtras::gt_plt_bar_stack(column = list_data,
                             width = 80,
                             labels = c("Original Medicare ", 
                                        " Medicare Advantage"),
                             palette = c("#ff4343", 
                                         "#0a1c2b"),
                             fmt_fn = scales::label_percent(accuracy = 0.01, 
                                                            suffix = " %")) |> 
  gt::tab_header(title = gt::md(
    "Medicare Beneficiary Enrollment: **2013 - 2022**")) |>
  gtExtras::gt_theme_538()
```

<br>

```{r}
mon_nat_list <- national |> 
  dplyr::filter(month %in% month.name) |> 
  dplyr::select(year, month, bene_orig, bene_ma_oth) |> 
  dplyr::mutate(pct_orig = bene_orig / (bene_orig + bene_ma_oth),
                pct_ma = bene_ma_oth / (bene_orig + bene_ma_oth)) |> 
  tidyr::pivot_longer(cols = c(pct_orig, pct_ma), 
                      names_to = "measure", 
                      values_to = "pct") |> 
  dplyr::group_by(year, month) |> 
  dplyr::summarise(list_data = list(pct), .groups = "drop")

mon_nat_base <- national |> 
  dplyr::filter(month %in% month.name) |> 
  dplyr::select(year, month, bene_total) |> 
  dplyr::mutate(bene_roll_avg = slider::slide_mean(bene_total, before = 1)) |> 
  change_abs(bene_total, year) |> 
  change_pct(bene_total, bene_total_chg, year) |> 
  dplyr::relocate(bene_roll_avg, .after = bene_total)

dplyr::left_join(mon_nat_base, 
                 mon_nat_list, 
                 by = dplyr::join_by(year, month)) |>  
  gt::gt() |> 
  gt::fmt_number(columns = c(bene_total, 
                             bene_roll_avg), 
                             decimals = 0) |> 
  gt::fmt_number(columns = c(bene_total_chg), 
                 decimals = 0, 
                 force_sign = TRUE) |> 
  gt::fmt_percent(columns = bene_total_pct, 
                  decimals = 2, 
                  force_sign = TRUE) |> 
  gt::sub_missing(columns = dplyr::everything(), 
                  missing_text = "--") |> 
  gt::cols_merge_n_pct(col_n = bene_total_chg, 
                       col_pct = bene_total_pct) |> 
  gt::cols_label(bene_total = "Total", 
                 bene_roll_avg = "Rolling Mean", 
                 bene_total_chg = "Monthly Change") |> 
  gt::cols_align(align = "right", columns = month) |> 
  gtExtras::gt_plt_bar_stack(column = list_data,
                             labels = c("Original  ", 
                                        "  Advantage"),
                             palette = c("#ff4343", 
                                         "#0a1c2b"),
                             fmt_fn = scales::label_percent(accuracy = 0.01, 
                                                            suffix = " %")) |> 
  gt::tab_header(title = gt::md(
    "Medicare Beneficiary Enrollment: **2013 - 2022**")) |>
  gtExtras::gt_theme_538()
```


<br>

```{r}
beneficiary_enrollment(level = "State", state = "GA")
```



```{r}
beneficiary_enrollment(level = "County", state = "GA", county = "Lowndes")
```







## Data Dictionary

```{r echo=FALSE}
tibble::tribble(
  ~Description,                                                          ~Variable,         ~Definition,
  "Year",                                                          "`Year`",          "Indicates the calendar year of Medicare enrollment",
  "Month",                                                         "`Month`",           "Indicates the month of Medicare enrollment",
  "Beneficiary State",                                             "`Bene_State`",       "Area of beneficiary residence",
  "Beneficiary County",                                            "`Bene_County`",                    "County of beneficiary residence",
  "Total Beneficiaries",                                           "`Tot_Benes`",                      "Count of all Medicare beneficiaries",
  "Original Medicare Beneficiaries",                               "`Orgnl_Mdcr_Benes`",               "Count of all Original Medicare beneficiaries",
  "Medicare Advantage and Other Health Plan Beneficiaries",         "`MA_and_Oth_Benes`",       "Count of all Medicare Advantage and Other Health Plan beneficiaries",
  "Total Aged Beneficiaries",                                       "`Aged_Tot_Benes`",         "Count of Medicare aged beneficiaries",
  "Aged ESRD Beneficiaries",                                        "`Aged_ESRD_Benes`",        "Count of Medicare aged beneficiaries with End Stage Renal Disease",
  "Aged Beneficiaries Without ESRD",                                "`Aged_No_ESRD_Benes`",     "Count of Medicare aged beneficiaries without End Stage Renal Disease",
  "Total Disabled Beneficiaries",                                   "`Dsbld_Tot_Benes`",               "Count of Medicare disabled beneficiaries",
  "Disabled Beneficiaries with ESRD and ESRD Only Beneficiaries",  "`Dsbld_ESRD_and_ESRD_Only_Benes`", "Count of Medicare disabled beneficiaries with End Stage Renal Disease and beneficiaries with End Stage Renal Disease only",
  
  "Disabled Beneficiaries Without ESRD", "`Dsbld_No_ESRD_Benes`", "Count of Medicare disabled beneficiaries without End Stage Renal Disease",
        "Total Medicare Part A and Part B Beneficiaries", "`A_B_Tot_Benes`", "Count of Medicare beneficiaries enrolled in Hospital Insurance (or Part A) and Supplementary Medical Insurance (or Part B)",
        "Original Medicare Part A and Part B Beneficiaries", "`A_B_Orgnl_Mdcr_Benes`", "Count of Original Medicare beneficiaries enrolled in Hospital Insurance (or Part A) and Supplementary Medical Insurance (or Part B)",
        "Medicare Advantage and Other Health Plan Part A and Part B Beneficiaries", "`A_B_MA_and_Oth_Benes`", "Count of Medicare Advantage and Other Health Plan beneficiaries enrolled in Hospital Insurance (or Part A) and Supplementary Medical Insurance (or Part B)",
        "Total Medicare Part D beneficiaries", "`Prscrptn_Drug_Tot_Benes`", "Count of all Medicare Prescription Drug (or Part D) beneficiaries",
        "Total Medicare Prescription Drug Plan beneficiaries", "`Prscrptn_Drug_PDP_Benes`", "Count of Medicare Prescription Drug (or Part D) beneficiaries enrolled in a Prescription Drug Plan",
        "Total Medicare Advantage Prescription Drug Plan beneficiaries", "`Prscrptn_Drug_MAPD_Benes`", "Count of Medicare Prescription Drug (or Part D) beneficiaries enrolled in a Medicare Advantage Prescription Drug plan") |> 
  dplyr::select(Variable, Description, Definition) |> 
  gt::gt() |> 
  gt::fmt_markdown(columns = Variable) |> 
  gtExtras::gt_theme_nytimes() |> 
  gtExtras::gt_merge_stack(col1 = Description, 
                           col2 = Definition,
                           small_cap = FALSE,
                           font_size = c("16px", "14px"),
                           font_weight = c("bold", "normal"),
                           palette = c("black", "darkgray")) |> 
  gt::opt_stylize(style = 4, color = "gray", add_row_striping = FALSE) |> 
  gt::opt_table_lines(extent = "default") |> 
  gt::opt_table_outline(style = "solid")

```


<br>

## Related Links

   - [Medicare Monthly Enrollment API](https://data.cms.gov/summary-statistics-on-beneficiary-enrollment/medicare-and-medicaid-reports/medicare-monthly-enrollment)
