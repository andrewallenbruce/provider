---
title: "Quality Payment Program"
subtitle: "Demographics, Patient Mix, and Performance"
author: "Andrew Bruce"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 600, 
  out.width = "100%"
)
options(scipen = 999)
```

```{r message=FALSE, warning=FALSE}
library(provider)
library(future)
library(furrr)
library(dplyr)
library(tidyr)
```

```{r}
nppes(npi = 1144544834) |> 
  glimpse()
```

<br>

```{r}
plan(multisession, workers = 4)
q <- quality_payment_(npi = 1144544834)
plan(sequential)
q
```


## Special Statuses

```{r}
select(q, year, statuses) |> 
  unnest(statuses)
```

<br>

```{r}
select(q, year, statuses) |> 
  unnest(statuses) |> 
  count(category, sort = TRUE)
```

<br>

## Individual Category Measures

```{r}
select(q, year, measures) |> 
  unnest(measures)
```


<br>

```{r}
select(q, year, measures) |> 
  unnest(measures) |> 
  count(measure, sort = TRUE)
```

<br>

## Quality Eligibility

```{r}
s <- 2017:2023 |>
  purrr::map(\(x) quality_eligibility(year = x, npi = 1043477615)) |>
  purrr::list_rbind()

"1043477615"

"org_apms"
"org_virtualGroups"

s |> 
  tidyr::unnest_longer(org_apms, keep_empty = TRUE) |> 
  tidyr::unpack(org_apms, names_sep = ".")
  tidyr::unnest(org_apms, keep_empty = TRUE) |> 
  #tidyr::unpack()
  tidyr::unnest(extremeHardshipReasons) |> 
  tidyr::unnest(qpPatientScores) |> 
  tidyr::unnest(qpPaymentScores) |> 
  janitor::remove_empty(which = c("rows", "cols"))
```


```{r}
s |> 
  dplyr::select(year, dplyr::starts_with("ind.")) |> 
  dplyr::mutate(scenario = "Individual", 
                .before = ind.aciHardship) |> 
  janitor::clean_names() |> 
  dplyr::mutate(dplyr::across(dplyr::starts_with("ind_"), as.character)) |> 
  tidyr::pivot_longer(!c(dplyr::any_of('year', 
                                       'scenario',
                                       'ind_specialty_code',
                                       '',
                                       '',
                                       '',
                                       ))) |> 
  dplyr::filter(value != TRUE, value != FALSE)
```
"ind_specialty_code"
"ind_specialty_specialty_description"
"ind_specialty_type_description"
"ind_specialty_category_reference"
"ind_hospital_vbp_score"
"ind_extreme_hardship_sources"
"ind_low_volume_status_reasons_low_vol_stus_rsn_cd"
"ind_low_volume_status_reasons_low_vol_stus_rsn_desc"

```{r}
quality_eligibility(year = 2017, npi = 1043477615) |> dplyr::glimpse()
```



```{r}
quality_eligibility(year = 2018, npi = 1144544834) |> glimpse()
```



```{r}
quality_eligibility(year = 2019, npi = 1144544834) |> glimpse()
```


```{r}
quality_eligibility(year = 2020, npi = 1144544834) |> glimpse()
```


```{r}
quality_eligibility(year = 2021, npi = 1144544834) |> glimpse()
```


```{r}
quality_eligibility(year = 2022, npi = 1144544834) |> glimpse()
```


```{r}
quality_eligibility(year = 2023, npi = 1144544834) |> glimpse()
```
