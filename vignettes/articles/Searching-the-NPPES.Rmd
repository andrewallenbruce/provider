---
title: "Searching the NPPES"
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  tidy = "styler",
  comment = "#>",
  dpi = 72, 
  out.width = "100%",
  dev = "png",
  dev.args = list(png = list(type = "cairo-png")),
  optipng = "-o1 -quiet",
  error = TRUE
)
```

# The NPPES NPI Registry

The [NPPES NPI Registry Public Search](https://npiregistry.cms.hhs.gov/) is a free directory of all active **National Provider Identifier** (NPI) records. Healthcare providers acquire their unique 10-digit NPIs to identify themselves in a standard way throughout their industry. After CMS supplies an NPI, they publish the parts of the NPI record that have public relevance, including the provider's name, specialty (taxonomy) and practice address. It enables you to search for providers in the NPPES (National Plan and Provider Enumeration System.) All information produced by the NPI Registry is provided in accordance with the NPPES Data Dissemination Notice. There is no charge to use the NPI Registry.

<br>

## The NPPES API

The NPPES *Application Programming Interface* (API) is a faster alternative to the [downloadable NPPES data files](https://www.cms.gov/Regulations-and-Guidance/Administrative-Simplification/NationalProvIdentStand/DataDissemination.html). It allows systems to access NPPES public data in real-time, rather than through batched uploads. The API retrieves data from NPPES daily. An API query will return a maximum of 200 results per request. The *Skip* field in the API will let you skip up to 1000 records. By using these two fields with your search criteria, you can get up to a maximum of 1,200 records over six requests.

<br>

# Searching the NPPES by NPI

The following is a basic example of searching for an NPI using the using `prov_npi_nppes()`. The only argument is the provider's 10-digit [National Provider Identifier](https://en.wikipedia.org/wiki/National_Provider_Identifier):

<br><br>

```{r message=TRUE, warning=TRUE}
# Load package
library(provider)

# Query the NPPES API
nppes_npi_resp <- prov_npi_nppes(1114499340)

# View the results
nppes_npi_resp
```


<br><br>

This returns a `tibble` containing the NPI that was searched for (`search`), the `datetime` of the query, an `outcome` status column and `data_lists`, a list-column containing a collection of variables and nested data frames:

```{r}
# The hierarchical "tree" of the response
lobstr::tree(nppes_npi_resp$data_lists, max_depth = 2)
```

<br><br>

The **variables** returned are as follows:

```{r}
lobstr::tree(nppes_npi_resp$data_lists[[1]][1:4])
```

<br><br>

 * `created_epoch`: date when the NPI was issued
 * `enumeration_type`: NPI Entity Type, either NPI-1(individual) or NPI-2(organizational)
 * `last_updated_epoch`: date when the information was last updated by the provider
 * `number`: provider's NPI, as listed in the NPPES

<br><br>

> Note: `last_updated_epoch` / `created_epoch` are dates in [Unix time](https://www.epochconverter.com/). They are repeated in the `basic` list as `last_updated` and `enumeration_date`, respectively.

<br><br>

The **list-columns** returned are as follows:

```{r}
lobstr::tree(nppes_npi_resp$data_lists[[1]][5:11])
```

<br><br>

 * `basic`: Basic information
 * `other_names`: Other names used by the provider
 * `addresses`: Primary location and mailing addresses
 * `taxonomies`: Specialty classification and related information
 * `identifiers`: Various other identifiers such as payer-specific IDs, CLIA numbers, etc.
 * `practice_locations`: Provider's practice locations
 * `endpoints`: Information regarding the provider's endpoints for Health Information Exchange (HIE)

<br><br>
 
> Note: All list-columns may not be available for every provider. This depends on factors such as NPI type, incorporated individual status, subpart delegation, and, quite simply, the information provided to the NPPES by providers.

<br><br>

## Unpack the Response

Flatten the response tibble into a tidy data format with `prov_nppes_unpack()`:

```{r}
prov_nppes_unpack(nppes_npi_resp)
```


<br><br>

# Search for Multiple NPIs

To search for more than one NPI at a time, there are two options, the first of which is to create an unnamed list (using `c()` as opposed to `list()`) of said NPIs:

```{r message=TRUE, warning=FALSE}
npi_list <- c(1336413418, 1710975040, 1659781227, 1528060837)
```


<br>

Then pipe the list into `prov_npi_nppes()` using [purrr's](https://purrr.tidyverse.org/) `map_dfr()` function to loop over the list:

```{r message=TRUE, warning=FALSE}
npi_list_resp <- npi_list |> purrr::map_dfr(prov_npi_nppes)
```


```{r echo=FALSE}
npi_list_resp
```

<br><br>


Unpacking the response is similar, adding only dplyr's `group_split()` function to the chain. The parameter entered into `group_split()` must be `search`.

<br><br>

```{r message=TRUE, warning=FALSE}
npi_list_resp |> dplyr::group_split(search) |> 
                 purrr::map_dfr(prov_nppes_unpack)
```


<br><br>

Searching for a column of NPIs in a data frame is only slightly different. I'll create a data frame with the same NPIs in the list example:

<br><br>

```{r}
npi_df <- data.frame(npi = c(1336413418, 1710975040, 1659781227, 1528060837))
```

```{r echo=FALSE}
npi_df
```


<br><br>

We can even chain the search and unpack function chains together using `|>`, R's lovely pipe. Again, the `group_split()` input should be the column containing the NPIs. 

Split and purrr, then split and purrr:

```{r}
npi_df_resp <- npi_df |> dplyr::group_split(npi) |> 
                         purrr::map_dfr(prov_npi_nppes) |> 
                         dplyr::group_split(search) |> 
                         purrr::map_dfr(prov_nppes_unpack)
```


```{r echo=FALSE}
npi_df_resp
```

<br><br>

At 46 columns wide, this output is fairly unwieldy, so it really depends on what you need to do with the data.


```{r}
npi_df_resp |> 
  knitr::kable(
    # col.names = c(
    # "ID", 
    # "Datetime", 
    # "Group", 
    # "Description", 
    # "Field"), 
    align = c('l')) |> 
  kableExtra::scroll_box(height = "500px")
```

<br><br><br><br>

### Constraints for Invalid Parameters

Several constraints have been implemented so as to not batter the NPPES API with invalid searches. The input must be 10 digits or the function will throw an error:

<br><br>

```{r, error=TRUE}
prov_npi_nppes(123456789)
```

<br><br>

It also must be a valid NPI. The `prov_npi_nppes()` function checks for validity using the [Luhn algorithm](https://en.wikipedia.org/wiki/Luhn_algorithm), as per it's implementation by [CMS](https://www.cms.gov/) (documented [here](https://www.cms.gov/Regulations-and-Guidance/Administrative-Simplification/NationalProvIdentStand/Downloads/NPIcheckdigit.pdf)):

<br><br>

```{r, error=TRUE}
prov_npi_nppes(1234567891)
```

<br><br>

Inputting letters will throw an error:

<br><br>

```{r, error=TRUE}
prov_npi_nppes(abcdefghij)
```

<br><br>

The Luhn check will catch any letters wrapped in quotes:

<br><br>

```{r, error=TRUE}
prov_npi_nppes("abcdefghij")
```

<br><br>

But will let quoted numbers through:

<br><br>

```{r, error=TRUE}
prov_npi_nppes("123456789")
```

As long as they're 10 digits long.

<br><br>


# API Documentation Overview

This section outlines the NPPES API's documentation, going over valid search inputs, constraints to those inputs, and descriptions of the many possible outputs.

<br><br>

```{r echo=FALSE}
provider::nppes_api_input |> 
  gt::gt() |> 
  gt::tab_options(
    source_notes.multiline = FALSE,
    footnotes.multiline = FALSE,
    heading.align = "left",
    row_group.background.color = "white",
    table.width = gt::pct(100)) |> 
  gt::cols_width(field ~ gt::px(215), description ~ gt::px(200)) |> 
  gt::fmt_markdown(columns = gt::everything()) |> 
  gtExtras::gt_theme_espn() |> 
  gt::opt_table_font(font = list(gt::google_font(name = "Karla"))) |> 
  gt::tab_header(title = gt::md("NPPES API Search Parameters")) |>
  gt::tab_source_note(source_note = gt::md("*Source:* [NPPES API Help](https://npiregistry.cms.hhs.gov/registry/help-api).")) |> 
  gt::opt_stylize(style = 6, color = "red")
```


<br><br>


```{r echo=FALSE}
provider::nppes_api_output |> 
  gt::gt(rowname_col = "field", groupname_col = "group") |>
  gt::tab_options(
    source_notes.multiline = FALSE,
    footnotes.multiline = FALSE,
    heading.align = "left",
    row_group.as_column = TRUE,
    row_group.background.color = "red",
    table.width = gt::pct(100), 
    row_group.default_label = "Other") |> 
  gt::cols_width(description ~ gt::px(300)) |> 
  gt::cols_align(align = "left", columns = gt::everything()) |> 
  gtExtras::gt_theme_espn() |> 
  gt::opt_table_font(font = list(gt::google_font(name = "Karla"))) |> 
  # gt::tab_row_group(label = "Taxonomies", rows = group %in% "taxonomies") |>
  # gt::tab_row_group(label = "Practice Locations", rows = group %in% "practiceLocations") |>
  # gt::tab_row_group(label = "Other Names", rows = group %in% "other_names") |>
  # gt::tab_row_group(label = "Identifiers", rows = group %in% "identifiers") |>
  # gt::tab_row_group(label = "Endpoints", rows = group %in% "endpoints") |>
  # gt::tab_row_group(label = "Basic Information", rows = group %in% "basic") |>
  # gt::tab_row_group(label = "Authorized Offficial", rows = group %in% "authorized_official") |>
  # gt::tab_row_group(label = "Addresses", rows = group %in% "addresses") |>
  gt::tab_header(title = gt::md("**NPPES** API Output Groups & Fields")) |>
  gt::tab_source_note(source_note = gt::md("*Source:* [NPPES API JSON Conversion Map](https://npiregistry.cms.hhs.gov/registry/Json-Conversion-Field-Map).")) |> 
  gt::opt_stylize(style = 6, color = "red")
```



<br><br>

## Terminology Notes

### Enumeration Type

Two categories of health care providers exist for NPI enumeration purposes: Entity *Type 1* (Individual) and Entity *Type 2* (Organizational).

#### NPI-1: Individual

Individual health care providers (including sole proprietors) may get an NPI as **Entity Type 1**. As a sole proprietor, they must apply for the NPI using your own SSN, not an Employer Identification Number (EIN) even if they have an EIN. As a sole proprietor, they may get only one NPI, just like any other individual.

The following factors **do not** affect whether a sole proprietor is an Entity Type 1:

-   Number of different office locations
-   Whether they have employees
-   Whether the IRS issued them an EIN.

<br>

> An **incorporated individual** is a single health care provider who forms and conducts business under a corporation. A sole proprietor **is not** an incorporated individual because the sole proprietor didn't form a corporation. If you're a sole/solo practitioner, it doesn't necessarily mean you're a sole proprietor, and vice versa. If you're an individual health care provider who's incorporated, you may need to get an NPI for yourself (Entity Type 1) and an NPI for your corporation or LLC (Entity Type 2).
#### NPI-2: Organizational

Organization health care providers are group health care providers eligible for NPIs as Entity Type 2. Organization health care providers may have a single employee or thousands of employees. An example is an incorporated individual who is an organization's only employee.

Some organization health care providers are made up of parts that work somewhat independently from their parent organization. These parts may offer different types of health care or offer health care in separate physical locations. These parts and their physical locations aren't themselves legal entities but are part of the organization health care provider (which is a legal entity). The NPI Final Rule refers to the parts and locations as subparts.

An organization health care provider can get its subparts their own NPIs. If a subpart conducts any HIPAA standard transactions on its own (separately from its parent), it must get its own NPI. Subpart determination makes sure that entities within a covered organization are uniquely identified in HIPAA standard transactions they conduct with Medicare and other covered entities. For example, a hospital offers acute care, laboratory, pharmacy, and rehabilitation services. Each of these subparts may need its own NPI because each sends its own standard transactions to one or more health plans.

<br>

> Subpart delegation doesn't affect Entity Type 1 health care providers. As individuals, these health care providers can't choose subparts and are not subparts.
