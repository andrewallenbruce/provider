---
title: "Mapping Providers"
subtitle: "Demographics, Patient Mix, and Performance"
description: "Demographics, Patient Mix, and Performance"
author: "Andrew Bruce"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 600, 
  out.width = "100%"
)
options(scipen = 999)
```


## Load Packages

```{r}
library(provider)
library(tidygeocoder)
library(purrr)
library(dplyr)
library(stringr)
library(ggplot2)
library(ggsflabel)
library(ggrepel)
library(gghighlight)
library(sf)
library(tigris)
library(zipcodeR)
library(fipio)
```


## Retrieve NPIs of all RHCs in Georgia

```{r}
rhcs <- providers(state = "GA", specialty_code = "00-17") |> 
  dplyr::distinct(npi) |> 
  dplyr::pull(npi) |> 
  purrr::map(\(x) nppes(npi = x)) |>
  purrr::list_rbind() |> 
  dplyr::select(npi,
                organization, 
                tx_desc,
                org_part,
                purpose,
                org_parent,
                on_type,
                on_org_name,
                address, 
                city, 
                state, 
                zip,
                pr_purpose, 
                pr_address, 
                pr_city, 
                pr_state, 
                pr_zip)
rhcs
```


## Stack Distinct `LOCATION` & `PRACTICE` Addresses

```{r}
stack <- dplyr::bind_rows(
  dplyr::select(rhcs, 
                npi,
                organization, 
                tx_desc,
                org_part,
                purpose,
                org_parent,
                on_type,
                on_org_name,
                address, 
                city, 
                state, 
                zip),
  dplyr::select(rhcs, 
                npi, 
                organization, 
                tx_desc,
                org_part,
                purpose = pr_purpose, 
                org_parent,
                on_type,
                on_org_name,
                address = pr_address, 
                city = pr_city, 
                state = pr_state, 
                zip = pr_zip)) |> 
  dplyr::filter(!is.na(purpose)) |> 
  tidyr::nest(specialty = tx_desc, 
              other_names = c(org_parent, 
                              on_type, 
                              on_org_name)) |> 
  add_counties(zcol = zip) |> 
  tidyr::unite("address", 
               address:state, 
               remove = TRUE, 
               sep = " ")
stack
```


## Send to `{tidygeocoder}`

```{r}
rhc_geo <- dplyr::select(stack, npi:zip) |> 
  tidygeocoder::geocode(address      = address, 
                        method       = "mapbox", 
                        full_results = TRUE, 
                        unique_only  = FALSE, 
                        return_input = TRUE) |> 
  dplyr::select(npi, zip, place_name, lat, long)
rhc_geo
```


## Retrieve Georgia counties shapefile from `{tigris}`

```{r}
ga_counties <- tigris::counties(state = "GA", year = 2022, progress_bar = FALSE)  
ga_counties
```


## `{ggplot}`

```{r}
p <- ggplot2::ggplot() + 
  ggplot2::geom_sf(data = ga_counties, fill = "darkgreen", colour = "white", alpha = 0.25) +
  #ggplot2::geom_sf(data = stack, size = 3, fill = "white") +
  ggplot2::geom_point(rhc_geo, 
                      mapping = ggplot2::aes(long, lat), 
                      fill = "white", 
                      color = "darkred", 
                      alpha = 0.75, 
                      size = 1.5, 
                      shape = 21, 
                      stroke = 0.5) +
  # geom_label_repel(rhc_crd, 
  #                 mapping = aes(long, lat, label = organization),
  #                 force_pull = 0,
  #                 force = 2,
  #                 direction = "both",
  #                 segment.curvature = -0.1, 
  #                 segment.ncp = 3, 
  #                 segment.angle = 20, 
  #                 min.segment.length = 0,
  #                 nudge_x = 2.5,
  #                 nudge_y = 0.5) +
  ggplot2::theme_void()

p + ggsflabel::lims_bbox(ga_counties)
```



