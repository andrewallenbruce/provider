---
title: "Mapping Providers"
subtitle: "Demographics, Patient Mix, and Performance"
description: "Demographics, Patient Mix, and Performance"
author: "Andrew Bruce"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 600, 
  out.width = "100%"
)
options(scipen = 999)
```


```{r}
library(provider)
library(tidygeocoder)
library(purrr)
library(dplyr)
library(ggplot2)
#library(ggsflabel)
library(ggrepel)
#library(gghighlight)
library(sf)
library(tigris)
```


```{r}
# Retrieve NPIs of all RHCs in Georgia
rhcs <- providers(state = "GA", specialty_code = "00-17") |> 
  dplyr::distinct(npi) |> 
  dplyr::pull(npi) |> 
  purrr::map(\(x) nppes(npi = x)) |>
  purrr::list_rbind()

# Separate & row-bind distinct LOCATION & PRACTICE Addresses
stack <- dplyr::bind_rows(
  dplyr::select(rhcs, npi, organization, on_org_name, org_parent, 
                purpose, address, city, state, zip),
  dplyr::select(rhcs, npi, organization, on_org_name, org_parent, 
                purpose = pr_purpose, 
                address = pr_address, 
                city = pr_city, 
                state = pr_state, 
                zip = pr_zip)) |> 
  dplyr::mutate(zip = zipcodeR::normalize_zip(zip)) |> 
  dplyr::filter(!is.na(purpose)) |> 
  dplyr::distinct()

# Prepare for geocoding
clean <- stack |> 
  #dplyr::mutate(address = campfin::normal_address(address)) |>
  tidyr::unite("address", address:state, remove = TRUE, sep = " ") |> 
  dplyr::distinct(address, .keep_all = TRUE)

# Geocode with {tidygeocoder}
rhc_crd <- tidygeocoder::geocode(clean, 
                                 address = address, 
                                 method = "mapbox", 
                                 full_results = TRUE, 
                                 unique_only = FALSE, 
                                 return_input = TRUE) |> 
  dplyr::select(npi, organization, on_org_name, org_parent, purpose, address, place_name, lat, long)
```


```{r}
ga_counties <- tigris::counties("GA")

p <- ggplot(ga_counties) + 
  geom_sf(colour = "white") +
  geom_point(rhc_crd, mapping = aes(long, lat), fill = "orange", color = "darkred", alpha = 0.75, size = 2, shape = 21, stroke = 1) +
  # geom_label_repel(rhc_crd, 
  #                 mapping = aes(long, lat, label = organization),
  #                 force_pull = 0,
  #                 force = 2,
  #                 direction = "both",
  #                 segment.curvature = -0.1, 
  #                 segment.ncp = 3, 
  #                 segment.angle = 20, 
  #                 min.segment.length = 0,
  #                 nudge_x = 2.5,
  #                 nudge_y = 0.5) +
  theme_void()

p + lims_bbox(ga_counties)
```


```{r eval=FALSE}
# ----------------------------------------------
# `{zipcodeR}`: Retrieve Counties from Zip codes 
zip_db <- dplyr::tibble(zip_code_db) |> 
  dplyr::filter(state == "GA" | state == "FL") |> 
  dplyr::select(
    zipcode, 
    city = major_city, 
    county, 
    state, 
    lat, 
    lng, 
    pop_total = population, 
    pop_dense = population_density,
    med_income = median_household_income,
    dplyr::contains("bounds"))

# Join RHCs to Counties
rhc_zip <- dplyr::left_join(
  pivoted, 
  zip_db, 
  by = dplyr::join_by(state, zipnorm == zipcode))

# Create data frame of unique state/county pairs
# Remove "County" from county names
st_cnty <- rhc_zip |> 
  distinct(state, county) |> 
  mutate(county = stringr::str_remove(county, " County"))

# Make separate, equal-length lists of the states and counties
x <- list(st_cnty$state)
y <- list(st_cnty$county)

# Retrieve county FIPS codes
# Retrieve geometries based on county FIPS
z    <- purrr::map2(x, y, fipio::as_fips)
z_sf <- purrr::map(z, fipio::fips_geometry) |> purrr::list_rbind()
z_sf[[1]]

# Unlist & insert into new tibble with geometry
st_ct_fips <- dplyr::tibble(
  state = unlist(x),
  county = unlist(y),
  fips = unlist(z),
  geometry = z_sf[[1]])


# Create `{sf}` <MULTIPOLYGON> object
counties_sf <- sf::st_as_sf(st_ct_fips)
counties_sf

# -----------------------------------------------------
sf::st_crs(counties_sf)$epsg
sf::st_crs("EPSG:4326")$epsg
sf::st_crs(ga_base_map)$epsg

sf::st_crs(rhc_sf_points)$epsg

rhc_sf_points_4326 <- sf::st_transform(rhc_sf_points, 4326)

ga_base_map <- USA.state.boundaries::state_boundaries_wgs84 |> 
  dplyr::filter(STATE_ABBR == "GA")
fl_base_map <- USA.state.boundaries::state_boundaries_wgs84 |> 
  dplyr::filter(STATE_ABBR == "FL")

# -----------------------------------------------------------------------------
ggplot2::ggplot() +
  ggplot2::geom_sf(data = ga_base_map, 
                   fill = "white", 
                   linewidth = 0.25) +
  ggplot2::geom_sf(data = fl_base_map, 
                   fill = "white", 
                   linewidth = 0.25) +
  ggplot2::geom_sf(data = counties_sf, 
                   fill = "darkgreen", 
                   alpha = 0.3, 
                   color = "white", 
                   linewidth = 0.75) +
  ggplot2::geom_point(data = rhc_coords, 
                      ggplot2::aes(long, lat),
                      fill = "orange",
                      color = "darkred", 
                      alpha = 1, 
                      size = 2, 
                      shape = 21,
                      stroke = 1.5) +
  # ggplot2::geom_sf_text(data = rhc_sf_points_4326, 
             # ggplot2::aes(geometry = geometry, label = tx_desc)) +
  # ggplot2::coord_sf(crs = count_crs) +
  ggplot2::theme_void()
```

