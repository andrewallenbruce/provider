---
title: "Mapping Providers"
author: "Andrew Bruce"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 600, 
  out.width = "100%"
)
options(scipen = 999)

# camcorder::gg_record(
#   #dir = '',
#   width = 12,
#   height = 12 * 9 / 16,
#   dpi = 300,
#   bg = 'white')
```


## Load Packages

```{r}
library(provider)
```

<br>

## Retrieve Addresses of all RHCs in Georgia

```{r}
rhcs <- providers(state = "GA", specialty_code = "00-17") |> 
  dplyr::distinct(npi) |> 
  dplyr::pull(npi) |> 
  purrr::map(\(x) nppes(npi = x)) |>
  purrr::list_rbind() |> 
  dplyr::select(npi, organization, purpose, 
                on_org_name, address:zip, pr_purpose:pr_zip) |> 
  dplyr::distinct()
rhcs
```

<br>

## Stack Distinct `LOCATION` & `PRACTICE` Addresses

```{r}
org <- dplyr::select(rhcs, 
                     npi, 
                     organization, 
                     purpose, 
                     address:zip,
                     pr_purpose) |> 
  dplyr::filter(is.na(pr_purpose))

org$pr_purpose <- NULL

sub <- dplyr::select(rhcs, 
                     npi, 
                     organization = on_org_name,
                     purpose = pr_purpose, 
                     address = pr_address,
                     city = pr_city,
                     state = pr_state,
                     zip = pr_zip) |> 
  dplyr::filter(!is.na(purpose))

rhcs <- dplyr::bind_rows(org, sub) |> 
  dplyr::distinct() |> 
  add_counties(state, 
               zip, 
               add_fips = TRUE,
               add_geo = TRUE) |> 
  tidyr::unite("address", 
               address:state, 
               remove = TRUE, 
               sep = " ")
rhcs
```

<br>

## Filter to distinct counties for labelling

```{r}
county_pts <- dplyr::distinct(rhcs, .county, .keep_all = TRUE) |> 
  dplyr::select(.county, lat, lng) |> 
  dplyr::filter(.county != "Duval")
county_pts
```

<br>

## Geocode with `{tidygeocoder}`

```{r}
rhc_geo <- dplyr::select(rhcs, npi:zip) |> 
  dplyr::filter(zip != "32209") |> 
  tidygeocoder::geocode(address      = address, 
                        method       = "mapbox", 
                        full_results = TRUE, 
                        unique_only  = FALSE, 
                        return_input = TRUE) |> 
  dplyr::select(npi, zip, place_name, lat, long)
```

<br>

## Retrieve Georgia counties shapefile from `{tigris}`

```{r}
ga_counties <- tigris::counties(state = "GA", year = 2022, progress_bar = FALSE)
ga_counties <- rmapshaper::ms_simplify(ga_counties)
ga_counties
```

<br>

## Map with `{ggplot}`

```{r}
p <- ggplot2::ggplot() + 
  ggplot2::geom_sf(data = ga_counties, 
                   fill = "skyblue", 
                   colour = "white") +
  ggrepel::geom_label_repel(county_pts,
                  mapping = ggplot2::aes(lng, 
                                lat, 
                                label = .county),
                  colour = "grey30",
                  fill = "white",
                  alpha = 0.85,
                  force_pull = 0,
                  segment.curvature = -0.2,
                  segment.ncp = 3,
                  segment.angle = 10,
                  min.segment.length = 0,
                  label.size = 0) +
  ggplot2::geom_point(rhc_geo, 
                      mapping = ggplot2::aes(long, lat), 
                      fill = "yellow", 
                      color = "darkred", 
                      alpha = 0.85, 
                      size = 1.75, 
                      shape = 21, 
                      stroke = 0.75) +
  ggplot2::theme_void()

p + ggsflabel::lims_bbox(ga_counties)
```



