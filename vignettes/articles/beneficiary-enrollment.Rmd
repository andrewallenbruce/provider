---
title: "Beneficiary Enrollment"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = TRUE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 300, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)
options(scipen = 999)
```

```{r}
library(provider)
```

<br>

> *Current information on the number of Medicare beneficiaries with hospital/medical and prescription drug coverage, available for several geographical areas.*

<br>

The Medicare Monthly Enrollment data provides current monthly information on the number of Medicare beneficiaries with hospital/medical coverage and prescription drug coverage, available for several geographic areas including national, state/territory, and county. 

The hospital/medical coverage data can be broken down further by health care delivery (Original Medicare versus Medicare Advantage and Other Health Plans) and the prescription drug coverage data can be examined by those enrolled in stand-alone Prescription Drug Plans and those enrolled in Medicare Advantage Prescription Drug plans. 

The dataset includes enrollee counts on a rolling 12 month basis and also provides information on yearly trends. 

<br>

## Search Examples

Set the `level` argument to "National" and the `period` argument to "Year" to return year-by-year national data:

```{r}
beneficiary_enrollment(level = "National", 
                       period = "Year") |> 
  dplyr::select(!c(period:fips))
```

<br>

Or set just the `level` argument to include month-by-month data as well:

```{r}
beneficiary_enrollment(level = "National") |> 
  dplyr::select(!c(level:fips)) |> 
  dplyr::filter(period %in% month.name)
```

<br>

Setting the `level` to "State" will return data for each state:

```{r}
beneficiary_enrollment(period = "Year", 
                       level = "State") |> 
  dplyr::select(!c(period:state, county:fips))
```
<br>

Select a particular state:

```{r}
beneficiary_enrollment(period = "Year", 
                       level = "State",
                       state = "GA")
```

<br>

Each county in that state:

```{r}
beneficiary_enrollment(period = "Year", 
                       level = "County",
                       state = "GA")
```

<br>

Or a particular county:

```{r}
beneficiary_enrollment(period = "Year", 
                       level = "County",
                       state = "GA",
                       county = "Lowndes")
```

<br><br>

## Visualizations

<details><summary>Code for table</summary>

```{r}
# National by Year
tot_nation <- beneficiary_enrollment(level = "National", 
                                     period = "Year") |>
  dplyr::select(year, 
                level, 
                total = bene_total,
                orig = bene_orig,
                ma = bene_ma_oth,
                aged = bene_aged_total, 
                disabled = bene_dsb_total, 
                partsAB = bene_ab_total, 
                partD = bene_rx_total)
# State by Year
tot_state <- beneficiary_enrollment(level = "State", 
                                    period = "Year", 
                                    state = "GA") |> 
  dplyr::select(year, 
                state_name, 
                total = bene_total, 
                orig = bene_orig,
                ma = bene_ma_oth,
                aged = bene_aged_total, 
                disabled = bene_dsb_total, 
                partsAB = bene_ab_total, 
                partD = bene_rx_total) |> 
  dplyr::rename(level = state_name)
# County by Year
tot_county <- beneficiary_enrollment(level = "County", 
                                     period = "Year", 
                                     state = "GA", 
                                     county = "Lowndes") |> 
  dplyr::select(year, 
                county, 
                total = bene_total,
                orig = bene_orig,
                ma = bene_ma_oth,
                aged = bene_aged_total, 
                disabled = bene_dsb_total, 
                partsAB = bene_ab_total, 
                partD = bene_rx_total) |> 
  dplyr::rename(level = county)
# Bind together, calculate stats
final <- dplyr::bind_rows(
  tot_nation, 
  tot_state, 
  tot_county) |> 
  dplyr::group_by(level) |> 
  provider:::change_abs(total, year) |> 
  provider:::change_pct(total, total_chg, year) |> 
  dplyr::ungroup() |> 
  dplyr::mutate(orig_pct = orig / total,
                ma_pct = ma / total,
                aged_pct = aged / total,
                disabled_pct = disabled / total,
                ab_pct = partsAB / total,
                d_pct = partD / total) |> 
  dplyr::select(year, 
                level, 
                total_pct_chg = total_pct, 
                orig_pct,
                ma_pct,
                aged_pct, 
                disabled_pct, 
                ab_pct, 
                d_pct)
## gt Table
gt_pct <- final |>   
  gt::gt() |> 
  gt::tab_style(style = gt::cell_text(
    font = c(gt::google_font(name = "Fira Code"), gt::default_fonts())),
    locations = gt::cells_body(columns = dplyr::contains("pct"))) |> 
  gtExtras::gt_theme_538() |> 
  gt::fmt_percent(columns = dplyr::contains("pct"), decimals = 1) |> 
  gt::fmt_percent(columns = c(total_pct_chg), decimals = 1, force_sign = TRUE) |> 
  gt::sub_missing(columns = dplyr::everything(), missing_text = "--") |> 
  gt::cols_label(total_pct_chg = "% Change",
                 orig_pct = "Original",
                 ma_pct = "MA",
                 aged_pct = "Aged",
                 disabled_pct = "Disabled", 
                 ab_pct = "Pts A & B",
                 d_pct = "Part D") |> 
  gtExtras::gt_add_divider(
    columns = c("level", 
                "total_pct_chg", 
                "ma_pct", 
                "disabled_pct"), 
    style = "solid",
    color = "black",
    weight = gt::px(3),
    include_labels = FALSE) |>
  gt::tab_header(
    title = gt::md("Medicare Beneficiaries: **2013 - 2022**"),
    subtitle = gt::md("National, State, & County Percentage Comparisons for **Valdosta, Georgia**")) |> 
  gt::tab_source_note(source_note = "Source: data.cms.gov")
#|> gt::opt_table_font(font = gt::google_font(name = "Karla"))
```

</details>

```{r, echo=FALSE, eval=TRUE}
gt_pct |> gt::tab_options(table.width = gt::pct(100))
```

<br>

<details><summary>Code for table</summary>

```{r}
national <- beneficiary_enrollment(level = "National")

yr_nat_list <- national |> 
  dplyr::filter(period == "Year") |> 
  dplyr::select(year, bene_orig, bene_ma_oth) |> 
  dplyr::mutate(pct_orig = bene_orig / (bene_orig + bene_ma_oth),
                pct_ma = bene_ma_oth / (bene_orig + bene_ma_oth)) |> 
  tidyr::pivot_longer(cols = c(pct_orig, pct_ma), 
                      names_to = "measure", 
                      values_to = "pct") |> 
  dplyr::group_by(year) |> 
  dplyr::summarise(list_data = list(pct), .groups = "drop")

yr_nat_base <- national |> 
  dplyr::filter(period == "Year") |> 
  dplyr::select(year, bene_total) |> 
  provider:::change_abs(bene_total, year) |> 
  provider:::change_pct(bene_total, bene_total_chg, year)

nat <- dplyr::left_join(yr_nat_base, yr_nat_list, by = dplyr::join_by(year))

gt_nat <- nat |>   
  gt::gt() |> 
  gt::tab_style(
    style = gt::cell_text(font = c(gt::google_font(name = "Fira Code"), 
                                   gt::default_fonts())),
    locations = gt::cells_body(columns = c(bene_total, 
                                           bene_total_chg))) |> 
  gtExtras::gt_theme_538() |> 
  gt::fmt_number(bene_total, 
                 suffixing = TRUE, 
                 decimals = 2) |> 
  gt::fmt_number(bene_total_chg, 
                 suffixing = TRUE, 
                 force_sign = TRUE, 
                 decimals = 1) |> 
  gt::fmt_percent(columns = bene_total_pct, 
                  decimals = 1, 
                  force_sign = TRUE) |> 
  gt::sub_missing(columns = dplyr::everything(), 
                  missing_text = "--") |> 
  gt::cols_merge_n_pct(col_n = bene_total_chg,
                       col_pct = bene_total_pct) |>
  gt::cols_label(bene_total = "Total",
                 bene_total_chg = gt::md("Change (%)")) |> 
  gtExtras::gt_add_divider(columns = c("year", 
                                       "bene_total_chg"), 
                           style = "solid",
                           color = "black",
                           weight = gt::px(2),
                           include_labels = FALSE) |> 
  gtExtras::gt_plt_bar_stack(column = list_data, 
                             width = 80,
                             labels = c("Original  ", 
                                        " Advantage"),
                             palette = c("#ff4343", "black"),
                             fmt_fn = scales::label_percent(accuracy = 0.1, 
                                                            suffix = " %")) |> 
  gt::tab_header(title = gt::md("Medicare Beneficiary Enrollment: **2013 - 2022**"),
    subtitle = gt::md("National Totals, Year-Over-Year")) |> 
  gt::tab_source_note(source_note = "Source: data.cms.gov")

#|> gt::opt_table_font(font = gt::google_font(name = "Karla"))
```


</details>

```{r, echo=FALSE, eval=TRUE}
gt_nat |> gt::tab_options(table.width = gt::pct(100))
```


<br>

<details><summary>Code for table</summary>

```{r}
gt_comp <- beneficiary_enrollment(level = "National", 
                                  period = "Year") |> 
  dplyr::select(!c(period:fips)) |> 
  tidyr::pivot_longer(cols = dplyr::starts_with("bene_"), 
                      names_to = "stat", 
                      values_to = "value") |> 
  tidyr::pivot_wider(names_from = year, 
                     values_from = value) |> 
  gt::gt(rowname_col = "stat") |> 
  gt::tab_style(
    style = gt::cell_text(font = c(gt::google_font(name = "Fira Code"), 
                                   gt::default_fonts())),
    locations = gt::cells_body(columns = c(2:11))) |> 
  gtExtras::gt_theme_538() |> 
  gt::fmt_number(columns = c(2:11), suffixing = TRUE, decimals = 1) |> 
  gt::tab_row_group(label = gt::md("**Disabled Beneficiaries**"), 
                    rows = c("bene_dsb_total", 
                             "bene_dsb_no_esrd", 
                             "bene_dsb_esrd")) |> 
  gt::tab_row_group(label = gt::md("**Aged Beneficiaries**"), 
                    rows = c("bene_aged_total", 
                             "bene_aged_no_esrd", 
                             "bene_aged_esrd")) |> 
  gt::tab_row_group(label = gt::md("**Medicare Part D**"), 
                    rows = c("bene_rx_total", 
                             "bene_rx_pdp", 
                             "bene_rx_mapd", 
                             "bene_rx_elig", 
                             "bene_rx_full", 
                             "bene_rx_part", 
                             "bene_rx_none")) |> 
  gt::tab_row_group(label = gt::md("**Medicare Parts A & B**"), 
                    rows = c("bene_ab_total", 
                             "bene_ab_orig", 
                             "bene_ab_ma_oth")) |> 
  gt::tab_row_group(label = gt::md("**Original Medicare** / **Medicare Advantage**"), 
                    rows = c("bene_orig", 
                             "bene_ma_oth")) |> 
  gt::tab_row_group(label = gt::md("**Total Beneficiaries**"), 
                    rows = c("bene_total")) |> 
  gt::tab_header(title = gt::md(
    "Medicare Beneficiary Enrollment: **2013 - 2022**"),
    subtitle = gt::md("National Totals, Month-Over-Month")) |> 
  gt::tab_source_note(source_note = "Source: data.cms.gov")
```

</details>

```{r, echo=FALSE, eval=TRUE}
gt_comp
```


```{r, echo=FALSE, include=FALSE, eval=FALSE}
mon_nat_list <- national |> 
  dplyr::filter(period %in% month.name) |> 
  dplyr::select(year, period, bene_orig, bene_ma_oth) |> 
  dplyr::mutate(pct_orig = bene_orig / (bene_orig + bene_ma_oth),
                pct_ma = bene_ma_oth / (bene_orig + bene_ma_oth)) |> 
  tidyr::pivot_longer(cols = c(pct_orig, pct_ma), 
                      names_to = "measure", 
                      values_to = "pct") |> 
  dplyr::group_by(year, period) |> 
  dplyr::summarise(list_data = list(pct), .groups = "drop")

mon_nat_base <- national |> 
  dplyr::filter(period %in% month.name) |> 
  dplyr::select(year, period, bene_total) |> 
  provider:::change_abs(bene_total, year) |> 
  provider:::change_pct(bene_total, bene_total_chg, year)

mon <- dplyr::left_join(mon_nat_base, mon_nat_list, 
                 by = dplyr::join_by(year, period))

mon |> 
  gt::gt() |> 
  gt::tab_style(
    style = gt::cell_text(font = c(gt::google_font(name = "Fira Code"), 
                                   gt::default_fonts())),
    locations = gt::cells_body(columns = c(bene_total, bene_total_chg))) |> 
  gt::fmt_number(bene_total, suffixing = TRUE, decimals = 2) |> 
  gt::fmt_number(bene_total_chg, suffixing = TRUE, force_sign = TRUE, decimals = 1) |> 
  gt::fmt_percent(columns = bene_total_pct, decimals = 1, force_sign = TRUE) |> 
  gt::sub_missing(columns = dplyr::everything(), missing_text = "--") |> 
  gt::cols_merge_n_pct(col_n = bene_total_chg, 
                       col_pct = bene_total_pct) |> 
  gt::cols_align(align = "right", 
                 columns = period) |> 
  gt::cols_label(period = "Month", 
                 bene_total = "Total", 
                 bene_total_chg = gt::md("Change (%)")) |> 
  gtExtras::gt_add_divider(columns = c("period", 
                                       "bene_total_chg"), 
                           style = "solid",
                           color = "black",
                           weight = gt::px(2),
                           include_labels = FALSE) |> 
  gtExtras::gt_plt_bar_stack(column = list_data,
                             width = 40,
                             labels = c("Original  ", "  Advantage"),
                             palette = c("#ff4343", "black"),
                             fmt_fn = scales::label_percent(suffix = " %")) |> 
  gt::tab_header(title = gt::md(
    "Medicare Beneficiary Enrollment: **2013 - 2022**"),
    subtitle = gt::md("National Totals, Month-Over-Month")) |> 
  gt::tab_source_note(source_note = "Source: data.cms.gov") |>
  gtExtras::gt_theme_538()
```


## Data Dictionary

```{r}
beneficiary_enrollment(period = "Year", 
                       level = "State",
                       state = "GA") |> names()
```

```{r echo=FALSE}
tibble::tribble(
  ~Description,                                                          ~Variable,         ~Definition,
  "Year",                                                          "`year`",          "Indicates the calendar year of Medicare enrollment",
  "Month",                                                         "`month`",           "Indicates the month of Medicare enrollment",
  "Beneficiary State",                                             "`state`",       "Area of beneficiary residence",
  "Beneficiary County",                                            "`county`",                    "County of beneficiary residence",
  "Total Beneficiaries",                                           "`bene_total`",                      "Count of all Medicare beneficiaries",
  "Original Medicare Beneficiaries",                               "`bene_orig`",               "Count of all Original Medicare beneficiaries",
  "Medicare Advantage and Other Health Plan Beneficiaries",         "`bene_ma_oth`",       "Count of all Medicare Advantage and Other Health Plan beneficiaries",
  "Total Aged Beneficiaries",                                       "`bene_aged_total`",         "Count of Medicare aged beneficiaries",
  "Aged ESRD Beneficiaries",                                        "`bene_aged_esrd`",        "Count of Medicare aged beneficiaries with End Stage Renal Disease",
  "Aged Beneficiaries Without ESRD",                                "`bene_aged_no_esrd`",     "Count of Medicare aged beneficiaries without End Stage Renal Disease",
  "Total Disabled Beneficiaries",                                   "`bene_dsb_total`",               "Count of Medicare disabled beneficiaries",
  "Disabled Beneficiaries with ESRD and ESRD Only Beneficiaries",  "`bene_dsb_esrd`", "Count of Medicare disabled beneficiaries with End Stage Renal Disease and beneficiaries with End Stage Renal Disease only", 
  "Disabled Beneficiaries Without ESRD",                          "`bene_no_esrd`", "Count of Medicare disabled beneficiaries without End Stage Renal Disease",
  "Total Medicare Part A and Part B Beneficiaries",               "`bene_ab_total`", "Count of Medicare beneficiaries enrolled in Hospital Insurance (or Part A) and Supplementary Medical Insurance (or Part B)",
        "Original Medicare Part A and Part B Beneficiaries", "`bene_ab_orig`", "Count of Original Medicare beneficiaries enrolled in Hospital Insurance (or Part A) and Supplementary Medical Insurance (or Part B)",
        "Medicare Advantage and Other Health Plan Part A and Part B Beneficiaries", "`bene_ab_ma_oth`", "Count of Medicare Advantage and Other Health Plan beneficiaries enrolled in Hospital Insurance (or Part A) and Supplementary Medical Insurance (or Part B)",
        "Total Medicare Part D beneficiaries", "`Prscrptn_Drug_Tot_Benes`", "Count of all Medicare Prescription Drug (or Part D) beneficiaries",
        "Total Medicare Prescription Drug Plan beneficiaries", "`Prscrptn_Drug_PDP_Benes`", "Count of Medicare Prescription Drug (or Part D) beneficiaries enrolled in a Prescription Drug Plan",
        "Total Medicare Advantage Prescription Drug Plan beneficiaries", "`Prscrptn_Drug_MAPD_Benes`", "Count of Medicare Prescription Drug (or Part D) beneficiaries enrolled in a Medicare Advantage Prescription Drug plan") |> 
  dplyr::select(Variable, Description, Definition) |> 
  provider:::gt_datadict()
```


<br>

## Related Links

   - [Medicare Monthly Enrollment API](https://data.cms.gov/summary-statistics-on-beneficiary-enrollment/medicare-and-medicaid-reports/medicare-monthly-enrollment)
