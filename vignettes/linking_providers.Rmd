---
title: "Linking Providers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Linking Providers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 300, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)

library(printr)
```

```{r message=FALSE, warning=FALSE}
library(provider)
library(tidyverse)
```


Exploring links between providers can lead to many interesting insights. For example, there is a hospital in New York named **Elizabethtown Community Hospital**. 

<br>

Looking it up in the **Provider Enrollment** API gives us several avenues to go down:

<br>

```{r}
provider_enrollment(organization_name = "Elizabethtown Community Hospital")
```


<br>


```{r echo=FALSE, eval=FALSE, message=FALSE, warning=FALSE}
flow_data <- tibble(
  from = c(
    "3577554138", "3577554138", "3577554138",
    "1891785184", "1891785184",
    "1487923637",
    "1407061591"
           ), 
  to = c(
    "1891785184", "1487923637", "1407061591",
    "O20040521000534", "O20101110000259",
    "O20190719002511",
    "O20220827000145"
  ))

node_data <- tibble(
  name = c(
  "3577554138", 
  "1891785184", 
  "1487923637",
  "1407061591",
  "O20040521000534", 
  "O20101110000259",
  "O20190719002511",
  "O20220827000145"), 
  "ID Type" = c(
    "PAC ID",
    "NPI-2",
    "NPI-2",
    "NPI-2",
    "Enrollment ID (Organization)",
    "Enrollment ID (Organization)",
    "Enrollment ID (Organization)",
    "Enrollment ID (Organization)"))

# ggflowchart(flow_data, 
#             node_data, 
#             fill = 'ID Type',
#             text_size = 5,
#   text_colour = "black",
#   arrow_colour = "#585c45",
#   arrow_size = 0.15,
#   x_nudge = 0.2,
#   y_nudge = 0.45,
#   colour = "white",
#   horizontal = TRUE) +
#   theme(
#     plot.title = element_text(
#       size = 20,
#       hjust = 0.5,
#       face = "bold",
#       colour = "#585c45"),
#     legend.position = "top",
#     legend.title = element_text(size = 0))
```

Searching for it in the **Hospital Enrollment** API gives us even more detail:

<br>

```{r}
hospital_enrollment(organization_name = "Elizabethtown Community Hospital") |> 
  select(npi, organization_name, pac_id_org, facility_ccn, specialty_code)
```

<br>

The **Hospital Enrollment** API includes only Medicare Part A (hospital) providers, so we only get two rows back, but those include a new data point: two facility CCNs. Plugging those into the **Facility Affiliations** API, we can retrieve information on the individual providers practicing at this hospital. First, the all-numeric CCN (`331302`):

<br>

```{r}
facility_affiliations(facility_ccn = 331302) |> 
  select(-c(middle_name, suffix)) |> 
  head(10)
```


<br>

That returns individual providers affiliated with the hospital. Now to search the alphanumeric CCN (`33Z302`):


```{r}
facility_affiliations(facility_ccn = "33Z302")
```

<br>

That returns more affiliated individual providers that practice in the Hospital's nursing home..

<br>

> An *alphanumeric* CCN represents a sub-unit of the hospital, here a nursing home. We would get the same result if we'd set the `parent_ccn` argument to the numeric CCN, i.e. `facility_affiliations(parent_ccn = 331302)`

<br>

```{r eval=FALSE, echo=FALSE}
unique(elizabethtown$npi) |> 
  map(\(x) nppes_npi(npi = x)) |> 
  list_rbind() |> 
  filter(purpose != "MAILING")
```



