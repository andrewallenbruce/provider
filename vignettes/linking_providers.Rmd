---
title: "Linking Providers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Linking Providers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 300, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)

library(printr)
```

```{r message=FALSE, warning=FALSE}
library(provider)
library(dplyr)
```


Exploring links between providers can lead to many interesting insights. For example, there is a hospital in New York named **Elizabethtown Community Hospital**. 

<br>

Looking it up in the **Provider Enrollment** API gives us several avenues to go down:

<br>

```{r}
providers(organization = "Elizabethtown Community Hospital")
```



```{r}
hospitals(organization = "Elizabethtown Community Hospital") |> 
  select(npi:specialty, proprietary_nonprofit:status)
```

<br>

The **Hospital Enrollment** API includes only Medicare Part A (hospital) providers, so we only get two rows back, but those include a new data point: two facility CCNs. Plugging those into the **Facility Affiliations** API, we can retrieve information on the individual providers practicing at this hospital. First, the all-numeric CCN (`331302`):

<br>

```{r}
affiliations(facility_ccn = 331302) |> 
  select(-c(middle, suffix, parent_ccn)) |> 
  head(10)
```


<br>

That returns individual providers affiliated with the hospital. Now to search the alphanumeric CCN (`33Z302`):


```{r}
affiliations(facility_ccn = "33Z302") |> 
  select(-c(middle, suffix))
```

<br>

That returns more affiliated individual providers that practice in the Hospital's nursing home..

<br>

> An *alphanumeric* CCN represents a sub-unit of the hospital, here a nursing home. We would get the same result if we'd set the `parent_ccn` argument to the numeric CCN, i.e. `facility_affiliations(parent_ccn = 331302)`

<br>

```{r echo=FALSE, eval=FALSE}
unique(elizabethtown$npi) |> 
  map(\(x) nppes_npi(npi = x)) |> 
  list_rbind() |> 
  filter(purpose != "MAILING")

elizabeth.prov <- providers(organization = "Elizabethtown Community Hospital") |> 
  select(organization, 
         pac_organization = pac_id, 
         npi_organization = npi, 
         enroll_organization = enroll_id, 
         specialty)

elizabeth.hosp <- hospitals(organization = "Elizabethtown Community Hospital") |> 
  select(organization, 
         pac_organization = pac_id_org,
         npi_organization = npi,
         enroll_organization = enroll_id,
         facility_ccn)

elizabeth.affil <- elizabeth.hosp$facility_ccn |> 
  map(\(x) affiliations(facility_ccn = x)) |> 
  list_rbind() |> 
  select(pac_individual = pac_id_ind, 
         npi_individual = npi, 
         facility_ccn)

left_join(elizabeth.prov, 
          elizabeth.hosp, by = join_by(organization, 
                                       pac_organization, 
                                       npi_organization, 
                                       enroll_organization)) |> 
  left_join(elizabeth.affil, by = join_by(facility_ccn))

#######################################

elizabeth.prov.pac <- unique(elizabeth.affil$pac_individual) |>
  map(\(x) providers(pac_id = x)) |> 
  list_rbind() |> 
  select(pac_individual = pac_id,
         npi_individual = npi, 
         enroll_individual = enroll_id)

elizabeth.group <- unique(elizabeth.prov.pac$npi_individual) |>
  map(\(x) revalidation_group(npi = x)) |> 
  list_rbind() |> 
  select(npi_individual = npi, 
         enroll_individual = enroll_id,
         pac_organization = group_pac_id,
         enroll_organization = group_enroll_id,
         organization = group_legal_business_name,
         organization_reassignments = group_reassignments)

left_join(elizabeth.prov.pac, 
          elizabeth.group, 
          by = join_by(npi_individual, enroll_individual)) |> 
  arrange(desc(organization_reassignments))
```

<br>

### CLIA Laboratories

```{r}
laboratories(city = "Valdosta", 
             certificate = "accreditation") |> 
  dplyr::filter(confirmed == TRUE) |> 
  dplyr::select(name,
                clia_number,
                expiration_date, 
                termination_reason, 
                facility_type, 
                organization, 
                confirmed_date) |> 
  dplyr::distinct() |> 
  gt::gt(rowname_col = "name") |> 
  gt::cols_label(termination_reason = "status", 
                 clia_number = "clia",
                 expiration_date = "expires",
                 confirmed_date = "confirmed",
                 facility_type = "type") |> 
  gt::cols_label_with(fn = toupper) |> 
  gt::tab_spanner(label = "ACCREDITATION",
    columns = c(organization, confirmed_date)) |> 
  gt::fmt_date(columns = gt::contains("date"), 
               date_style = "m_day_year") |> 
  gt::opt_table_font(font = gt::google_font(name = "JetBrains Mono")) |>
  gt::opt_stylize(color = "red")
```

