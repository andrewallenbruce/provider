---
title: "Linking Providers"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Linking Providers}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 300, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)
```

```{r message=FALSE, warning=FALSE}
library(provider)
library(dplyr)
library(purrr)
library(DiagrammeR)
```


```{r}
grViz("
      digraph {
      graph [rankdir=LR]
      node [shape = Mrecord]
      0 [label = 'PAC ID | Organization' 
      color = 'white' 
      fillcolor = 'red' 
      style = filled
      fontcolor = 'white']
      1 [label = 'Enrollment ID | Organization | Hospital']
      2 [label = 'Enrollment ID | Individual']
      3 [label = 'NPI | Organization']
      4 [label = 'NPI | Individual']
      0 -> {1 2} [arrowhead = none]
      1 -> 3 [arrowhead = none]
      2 -> 4 [arrowhead = none]
      }",
      height = 300, width = 450)
```

<br>

## Individual Provider

```{r}
providers(pac = 7810891009)
```
<br>

```{r}
reassignments(pac = 7810891009)
```
<br>

```{r}
clinicians(pac = 7810891009)
```

<br>

```{r}
affiliations(pac = 7810891009)
```

<br>

```{r}
a <- affiliations(pac = 7810891009) |> 
  pull(facility_ccn) |>
  map_dfr(~hospitals(facility_ccn = .x, pivot = FALSE))

a |> group_by(enid_org) |> 
  #filter(multi_npi | flag == TRUE)
  distinct(npi, .keep_all = TRUE)
```

<br>

Exploring links between providers can lead to many interesting insights. For example, there is a hospital in New York named **Elizabethtown Community Hospital**. 

```{r}
providers(organization = "Elizabethtown Community Hospital")
```



```{r}
hospitals(organization = "Elizabethtown Community Hospital")
```

<br>

The **Hospital Enrollment** API includes only Medicare Part A (hospital) providers, so we only get two rows back, but those include a new data point: two facility CCNs. Plugging those into the **Facility Affiliations** API, we can retrieve information on the individual providers practicing at this hospital. First, the all-numeric CCN (`331302`):

<br>

```{r}
affiliations(facility_ccn = 331302)
```


<br>

That returns individual providers affiliated with the hospital. Now to search the alphanumeric CCN (`33Z302`):


```{r}
affiliations(facility_ccn = "33Z302")
```

<br>

That returns more affiliated individual providers that practice in the Hospital's nursing home..

<br>

> An *alphanumeric* CCN represents a sub-unit of the hospital, here a nursing home. We would get the same result if we'd set the `parent_ccn` argument to the numeric CCN, i.e. `affiliations(parent_ccn = 331302)`

