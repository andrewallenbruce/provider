---
title: "Overview of Provider"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Overview of Provider}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse  = TRUE,
  echo      = TRUE, 
  message   = FALSE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 300, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)
```

```{r}
library(provider)
```

<br>

## General Information

<br>

```{r}
info <- nppes_npi(npi = 1043477615)
```

<details><summary>Code for table</summary>

```{r}
info_1 <- info |> 
  dplyr::slice_head() |> 
  dplyr::select(npi:entype, 
                enumeration_duration, 
                first_name:phone_number)

info_2 <- info_1 |> 
  provider:::gt_prov(source = "Source: NPPES NPI Public Registry.", 
                     checkmark = c("sole_proprietor")) |> 
  gt::tab_header(title = paste0("General Information for: ", 
                                info_1$first_name, " ", 
                                info_1$middle_name, ". ", 
                                info_1$last_name, ", ", 
                                info_1$credential),
                 subtitle = paste0("Practice Location at: ",
                                   info_1$street, " ",
                                   info_1$city, ", ",
                                   info_1$state, " ",
                                   info_1$zipcode)) |> 
  gt::cols_hide(columns = c(first_name, 
                            middle_name, 
                            last_name, 
                            credential,
                            street,
                            city,
                            state,
                            zipcode,
                            purpose,
                            country))
```

</details>


```{r, echo=FALSE, eval=TRUE}
info_2
```


<br><br>

<details><summary>Code for table</summary>


```{r}
info_3 <- info |> 
  dplyr::slice_head(n = 3) |> 
  dplyr::select(tx_code:tx_desc, tx_state:tx_primary) |> 
  provider:::gt_prov(source = "Source: NPPES NPI Public Registry.", 
                     checkmark = c("tx_primary")) |> 
  gt::tab_header(title = paste0("Taxonomy Information: ", 
                                info_1$first_name, " ", 
                                info_1$middle_name, ". ", 
                                info_1$last_name, ", ", 
                                info_1$credential),
                 subtitle = paste0("Practice Location at: ",
                                   info_1$street, " ",
                                   info_1$city, ", ",
                                   info_1$state, " ",
                                   info_1$zipcode)) |> 
  gt::cols_label(tx_code = "Taxonomy",
                 tx_desc = "Description",
                 tx_state = "State",
                 tx_license = "License",
                 tx_primary = "Primary")
```


</details>

```{r, echo=FALSE, eval=TRUE}
info_2
```


<br>


```{r}
order_refer(npi = 1043477615) |> 
  provider:::gt_prov(divider = c("last_name"), 
                     checkmark = c("partb", "dme", "hha", "pmd"),
                     title = "Medicare Order & Referring Eligibility",
                     source = "Source: data.cms.gov")
```


<br>

```{r}
doctors_and_clinicians(npi = 1043477615)
```

<br>

```{r}
facility_affiliations(npi = 1043477615)
```

<br>

```{r}
facility_affiliations(npi = 1043477615) |> 
  dplyr::pull(facility_ccn) |> 
  purrr::map(\(x) hospital_enrollment(facility_ccn = x)) |> 
  purrr::list_rbind()
```

<br>

```{r}
revalidation_date(npi = 1043477615)
```
<br>

```{r}
revalidation_reassign(npi = 1043477615)
```
<br>

```{r}
revalidation_group(npi = 1043477615)
```

<br>

```{r}
provider_enrollment(npi = 1043477615)
```

<br>

```{r}
taxonomy_crosswalk(taxonomy_code = "207RC0000X")
```

<br>

```{r}
missing_information(npi = 1043477615)
```

<br>

```{r, message=FALSE}
opt_out(npi = 1043477615)
```

<br>

```{r, message=FALSE}
order_refer(npi = 1043477615)
```

<br>

```{r}
2014:2021 |> 
  purrr::map(\(x) physician_by_service(year = x, npi = 1043477615)) |> 
  purrr::list_rbind()
```

<br>

```{r}
2014:2021 |> 
  purrr::map(\(x) physician_by_provider(year = x, npi = 1043477615)) |> 
  purrr::list_rbind()
```


```{r echo=FALSE, eval=FALSE, include=FALSE}
# First row of data
mpop_ex_2020_row1 <- mpop_ex_2020 |> dplyr::filter(dplyr::row_number() %in% 1)

# First, last, credentials
mpop_ex_name_cred <- stringr::str_c(
  stringr::str_trim(mpop_ex_2020_row1$rndrng_prvdr_first_name, "both"), " ",
  stringr::str_trim(mpop_ex_2020_row1$rndrng_prvdr_last_org_name, "both"), ", ",
  stringr::str_trim(mpop_ex_2020_row1$rndrng_prvdr_crdntls, "both"))

# NPI
mpop_ex_npi <- stringr::str_c(stringr::str_trim(mpop_ex_2020_row1$rndrng_npi, "both"), "")

# Address
mpop_ex_address <- stringr::str_c(
  stringr::str_trim(mpop_ex_2020_row1$rndrng_prvdr_st1, "both"), " ",
  stringr::str_trim(mpop_ex_2020_row1$rndrng_prvdr_city, "both"), ", ",
  stringr::str_trim(mpop_ex_2020_row1$rndrng_prvdr_state_abrvtn, "both"), " ",
  stringr::str_trim(mpop_ex_2020_row1$rndrng_prvdr_zip5, "both"))



gt_table <- mpop_13_20 |>
  dplyr::select(year,
                hcpcs     = hcpcs_cd,
                benefits  = tot_benes,
                services  = tot_srvcs,
                avg_bill  = avg_sbmtd_chrg,
                avg_allow = avg_mdcr_alowd_amt,
                avg_pay   = avg_mdcr_pymt_amt) |> 
  dplyr::group_by(hcpcs) |> 
  dplyr::summarize(
    ben_sum    = sum(benefits),
    ben_mean   = mean(benefits),
    ben_spark  = list(benefits),
    serv_sum   = sum(services),
    serv_mean  = mean(services),
    serv_spark = list(services),
    char_sum   = sum(avg_bill),
    char_mean  = mean(avg_bill),
    char_spark = list(avg_bill),
    all_sum    = sum(avg_allow),
    all_mean   = mean(avg_allow),
    all_spark  = list(avg_allow),
    pay_sum    = sum(avg_pay),
    pay_mean   = mean(avg_pay),
    pay_spark  = list(avg_pay),
    .groups = "drop") |> 
  dplyr::filter(ben_sum > 22) |> 
  dplyr::arrange(desc(ben_sum))


gt_output <- gt_table |> 
  gt::gt() |> 
  gt::tab_header(
  title = gt::md(paste0(mpop_ex_name_cred, "**Medicare Data Report**: 2013 - 2020.")), 
  subtitle = gt::md(
  "NPI: 1760485387. HCPCS Codes with a beneficiary count *less than 30* have been excluded.")) |> 
  gtExtras::gt_theme_538() |> 
  gt::tab_options(footnotes.multiline = TRUE, 
                  table.font.size = "16px",
                  heading.title.font.size = "22px") |> 
  gtExtras::gt_plt_sparkline(ben_spark, 
                             type = "ref_iqr", 
                             fig_dim = c(5, 30), 
                             same_limit = FALSE, 
                             label = FALSE,
                             palette = c("black", 
                                         "black", 
                                         "blue", 
                                         "green", 
                                         "blue")) |> 
  gtExtras::gt_plt_sparkline(serv_spark, 
                             type = "ref_iqr", 
                             fig_dim = c(5, 30), 
                             same_limit = FALSE, 
                             label = FALSE,
                             palette = c("black", 
                                         "black", 
                                         "blue", 
                                         "green", 
                                         "blue")) |> 
  gtExtras::gt_plt_sparkline(char_spark, 
                             type = "ref_iqr", 
                             fig_dim = c(5, 30), 
                             same_limit = FALSE, 
                             label = FALSE,
                             palette = c("black", 
                                         "black", 
                                         "blue", 
                                         "green", 
                                         "orange")) |> 
  gtExtras::gt_plt_sparkline(all_spark, 
                             type = "ref_iqr", 
                             fig_dim = c(5, 30), 
                             same_limit = FALSE, 
                             label = FALSE,
                             palette = c("black", 
                                         "black", 
                                         "blue", 
                                         "green", 
                                         "orange")) |> 
  gtExtras::gt_plt_sparkline(pay_spark, 
                             type = "ref_iqr", 
                             fig_dim = c(5, 30), 
                             same_limit = FALSE, 
                             label = FALSE,
                             palette = c("black", 
                                         "black", 
                                         "blue", 
                                         "green", 
                                         "orange")) |> 
  gtExtras::gt_add_divider(columns = "hcpcs", 
                           style = "solid", 
                           include_labels = FALSE,
                           weight = gt::px(3),
                           color = "gray") |>
  gt::fmt_number(columns = c(ben_sum:ben_mean, 
                             serv_sum:serv_mean), 
                             decimals = 0) |> 
  gt::fmt_currency(columns = c(char_sum:char_mean, 
                               all_sum:all_mean, 
                               pay_sum:pay_mean), 
                               currency = "USD") |> 
  gt::tab_spanner(label = "Beneficiaries", 
                  id = "ben", 
                  columns = c(ben_sum, 
                              ben_mean, 
                              ben_spark)) |> 
  gt::tab_spanner(label = "Services", 
                  id = "serv", 
                  columns = c(serv_sum, 
                              serv_mean, 
                              serv_spark)) |> 
  gt::tab_spanner(label = "Submitted Charge", 
                  columns = c(char_sum,
                              char_mean, 
                              char_spark)) |> 
  gt::tab_spanner(label = "Allowed Amount", 
                  columns = c(all_sum,
                              all_mean, 
                              all_spark)) |> 
  gt::tab_spanner(label = "Payment", 
                  columns = c(pay_sum,
                              pay_mean, 
                              pay_spark)) |> 
  gt::cols_label(ben_sum = "Count", 
                 ben_mean = "Average", 
                 ben_spark = "Trend") |> 
  gt::cols_label(serv_sum = "Count", 
                 serv_mean = "Average", 
                 serv_spark = "Trend") |> 
  gt::cols_label(char_sum = "Sum",
                 char_mean = "Average", 
                 char_spark = "Trend") |> 
  gt::cols_label(all_sum = "Sum",
                 all_mean = "Average", 
                 all_spark = "Trend") |> 
  gt::cols_label(pay_sum = "Sum", 
                 pay_mean = "Average", 
                 pay_spark = "Trend") |> 
  gt::tab_source_note(
    source_note = gt::md("Data Source: **Medicare** Physician & Other Practitioners by Provider and Service, 2013 - 2020.")) |> 
  gt::tab_footnote(
    footnote = gt::md("Number of *distinct* Medicare beneficiaries receiving the service for each HCPCS code."), 
    locations = gt::cells_column_spanners(spanners = "ben")) |> 
  gt::tab_footnote(
    footnote = gt::md("Number of services provided. *Note: The metrics used to count the number provided can vary from service to service.*"),
    locations = gt::cells_column_spanners(spanners = "serv")) |> 
  gtExtras::gt_color_rows(columns = ben_sum, 
                          palette = "RColorBrewer::Blues", pal_type = "continuous", domain = range(gt_table$ben_sum)) |> 
  gtExtras::gt_color_rows(columns = ben_mean, 
                          palette = "RColorBrewer::Blues", pal_type = "continuous", domain = range(gt_table$ben_mean)) |> 
  gtExtras::gt_color_rows(columns = serv_sum, 
                          palette = "RColorBrewer::Blues", pal_type = "continuous", domain = range(gt_table$serv_sum)) |> 
  gtExtras::gt_color_rows(columns = serv_mean, 
                          palette = "RColorBrewer::Blues", pal_type = "continuous", domain = range(gt_table$serv_mean)) |> 
  gtExtras::gt_color_rows(columns = char_sum, 
                          palette = "RColorBrewer::Oranges", pal_type = "continuous", domain = range(gt_table$char_sum)) |> 
  gtExtras::gt_color_rows(columns = char_mean, 
                          palette = "RColorBrewer::Oranges", pal_type = "continuous", domain = range(gt_table$char_mean)) |> 
  gtExtras::gt_color_rows(columns = all_sum, 
                          palette = "RColorBrewer::Oranges", pal_type = "continuous", domain = range(gt_table$all_sum)) |> 
  gtExtras::gt_color_rows(columns = all_mean, 
                          palette = "RColorBrewer::Oranges", pal_type = "continuous", domain = range(gt_table$all_mean)) |> 
  gtExtras::gt_color_rows(columns = pay_sum, 
                          palette = "RColorBrewer::Oranges", pal_type = "continuous", domain = range(gt_table$pay_sum)) |> 
  gtExtras::gt_color_rows(columns = pay_mean, 
                          palette = "RColorBrewer::Oranges", pal_type = "continuous", domain = range(gt_table$pay_mean)) |> 
  gt::opt_vertical_padding(scale = 1.5)
```

<br>
