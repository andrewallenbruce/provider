---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE,
  message   = TRUE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "#>",
  dpi       = 300, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)
```

# `provider` <img src="man/figures/logo.svg" align="right" height="200" />

<!-- badges: start -->
[![R-CMD-check](https://github.com/andrewallenbruce/provider/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/andrewallenbruce/provider/actions/workflows/R-CMD-check.yaml)
[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![Project Status: WIP - Initial development is in progress, but there has not yet been a stable, usable release suitable for the public.](https://www.repostatus.org/badges/latest/wip.svg)](https://www.repostatus.org/#wip)
[![License: MIT](https://img.shields.io/badge/license-MIT-blue.svg)](https://choosealicense.com/licenses/mit/)
[![code size](https://img.shields.io/github/languages/code-size/andrewallenbruce/provider.svg)](https://github.com/andrewallenbruce/provider)
[![last commit](https://img.shields.io/github/last-commit/andrewallenbruce/provider.svg)](https://github.com/andrewallenbruce/provider/commits/main)
[![Codecov test coverage](https://codecov.io/gh/andrewallenbruce/provider/branch/main/graph/badge.svg)](https://app.codecov.io/gh/andrewallenbruce/provider?branch=main)
[![CodeFactor](https://www.codefactor.io/repository/github/andrewallenbruce/provider/badge)](https://www.codefactor.io/repository/github/andrewallenbruce/provider)
![GitHub milestone](https://img.shields.io/github/milestones/progress/andrewallenbruce/provider/1?color=white&logo=milestones)
<!-- badges: end -->

> Providing easy access to [healthcare provider](https://en.wikipedia.org/wiki/Health_care_provider)-centric data through publicly available APIs & sources.
 

<br>

## Installation

You can install the development version of `provider` from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("andrewallenbruce/provider")
```
``` r
# install.packages("remotes")
remotes::install_github("andrewallenbruce/provider")
```

```{r results='asis', echo=FALSE}
provider:::function_tbl() |> 
  dplyr::arrange(Function) |> 
  gluedown::md_table()
```

<br>

## Motivation

```{r echo=TRUE}
library(provider)
```

<br>

The goal of `provider` is to make the experience of getting location data easier and more consistent across a wide variety of sources.

This package is primarily focused on accessing public API data that can be linked together via a healthcare provider's National Provider Identifier (NPI). Thus far, none of the APIs require the creation of a user account or API key.

<br>

### NPPES NPI Registry

```{r eval=FALSE, echo=FALSE}
npi_list <- list(npi = c(1710983663,
                             1710975040,
                             1659781227,
                             1336413418,
                             1003026055,
                             1316405939,
                             1720392988,
                             1518184605,
                             1922056829,
                             1083879860,
                             1346243805,
                             1679576722,
                             1093718892,
                             1477556405,
                             1770586539,
                             1871596692,
                             1174526925, 
                             1720081441,
                             1558364273,
                             1801899513))

npi_list |> nppes_npi_multi()
```

```{r}
nppes_npi_new(npi = 1316405939)
```



### CMS Physician Facility Affiliations

```{r}
facility_affiliations(npi = 1003019563)
facility_affiliations(facility_ccn = "060004")
facility_affiliations(parent_ccn = 670055)
facility_affiliations(first_name = "John", last_name = "Hill", facility_type = "Home Health Agency")
```

### Hospital Enrollments

```{r}
hospital_enrollment(facility_ccn = "060004")
```


### CMS Doctors and Clinicians National File

```{r}
doctors_and_clinicians(npi = 1407263999)
doctors_and_clinicians(med_sch = "NEW YORK UNIVERSITY SCHOOL OF MEDICINE", grad_year = 2003, state = "FL")
```


### CMS Missing Contact Information

```{r}
missing_information(npi = 1144224569)
```

### Medicare Order and Referring

```{r}
order_refer(npi = 1083879860)
```


### Medicare Opt-Out Affidavits

```{r}
opt_out(last_name = "Aaron")
```


### Medicare Provider and Supplier Taxonomy Crosswalk

```{r}
taxonomy_crosswalk(specialty_desc = "Rehabilitation Agency")
taxonomy_crosswalk(specialty_code = "B4[14]")
```


### Medicare Fee-For-Service Public Provider Enrollment

```{r}
provider_enrollment(npi = 1083879860)
```


### Medicare Pending Initial Logging and Tracking

```{r}
pending_applications(npi = 1487003984, type = "physician")
pending_applications(npi = 1487003984, type = "non-physician")
pending_applications(last_name = "Abbott", type = "non-physician")
pending_applications(first_name = "John", type = "physician")
```

### Medicare Revalidation APIs

```{r}
# Revalidation Due Date List
revalidation_date(npi = 1710912209)

# Revalidation Reassignment List
revalidation_reassign(ind_npi = 1710912209)

# Revalidation Clinic Group Practice Reassignment
revalidation_group(ind_npi = 1710912209)
```


### CMS Open Payments API

```{r}
open_payments(recipient_npi = 1043218118)
```


### Medicare Monthly Enrollment API

```{r}
beneficiary_enrollment(year = 2021, geo_level = "County", state_abb = "GA", month = NULL)
```

### Medicare Physician & Other Practitioners APIs

```{r}
# by Provider and Service
physician_by_service(npi = 1003000126)

# by Geography and Service
physician_by_geography(geo_desc = "Maryland", year = 2020)

# by Provider
physician_by_provider(npi = 1003000126, year = 2020)
```


```{r eval=FALSE, echo=FALSE}
#purrr::map_dfr(2013:2020, ~physician_by_service(npi = 1003000126, year = .x))

srvcs <- provider::physician_by_service(npi = 1003000126, year = 2020) |> 
         tidyr::unnest(cols = c(rndrng_prvdr, totals_srvcs, hcpcs, averages))

ind <- srvcs |> 
  dplyr::mutate(level = "Individual") |> 
  dplyr::select(year, level, tot_benes:tot_srvcs, hcpcs_cd, 
                avg_sbmtd_chrg:avg_mdcr_pymt_amt) |> 
  dplyr::arrange(dplyr::desc(year), dplyr::desc(tot_srvcs))

state <- purrr::map_dfr(srvcs$hcpcs_cd, ~physician_by_geography(geo_desc = "Maryland", year = 2020, hcpcs_code = .x))

state <- state |> 
  dplyr::filter(place_of_srvc == "F") |>  
  dplyr::select(year, level = rndrng_prvdr_geo_lvl, tot_benes:tot_srvcs, hcpcs_cd, 
                avg_sbmtd_chrg:avg_mdcr_pymt_amt)

nat <- purrr::map_dfr(srvcs$hcpcs_cd, ~physician_by_geography(geo_level = "National", year = 2020, hcpcs_code = .x))

nat <- nat |> 
  dplyr::filter(place_of_srvc == "F") |>  
  dplyr::select(year, 
                level = rndrng_prvdr_geo_desc,
                tot_benes:tot_srvcs,
                hcpcs_cd, 
                avg_sbmtd_chrg:avg_mdcr_pymt_amt) |> 
  dplyr::arrange(dplyr::desc(year), dplyr::desc(tot_srvcs))

ind_lng <- ind |> 
  dplyr::select(!c(year)) |> 
  tidyr::pivot_longer(!c(level, hcpcs_cd)) |> 
  dplyr::mutate(value = round(value, 2))

st_lng <- state |> 
  dplyr::select(!c(year)) |> 
  tidyr::pivot_longer(!c(level, hcpcs_cd)) |> 
  dplyr::mutate(value = round(value, 2))

nat_lng <- nat |> 
  dplyr::select(!c(year)) |> 
  tidyr::pivot_longer(!c(level, hcpcs_cd)) |> 
  dplyr::mutate(value = round(value, 2))

join_2020 <- dplyr::full_join(ind_lng, st_lng, by = c("hcpcs_cd", "name", "level", "value")) |> 
  dplyr::full_join(nat_lng, by = c("hcpcs_cd", "name", "level", "value")) |> 
  dplyr::arrange(hcpcs_cd, name)

join_2020 |> 
  dplyr::filter(name == "avg_sbmtd_chrg") |> 
  tidyr::pivot_wider(names_from = level, 
                     names_glue = "{level}_avg_charge", 
                     values_from = value) |> 
  dplyr::select(!c(name)) |> 
  gluedown::md_table()

join_2020 |> 
  dplyr::filter(name == "avg_mdcr_alowd_amt") |> 
  tidyr::pivot_wider(names_from = level, 
                     names_glue = "{level}_avg_allowed", 
                     values_from = value) |> 
  dplyr::select(!c(name)) |> 
  gluedown::md_table()

join_2020 |> 
  dplyr::filter(name == "avg_mdcr_pymt_amt") |> 
  tidyr::pivot_wider(names_from = level, 
                     names_glue = "{level}_avg_pymt", 
                     values_from = value) |> 
  dplyr::select(!c(name)) |> 
  gluedown::md_table()
```

```{r eval=FALSE, echo=FALSE}
prov <- purrr::map_dfr(as.character(2013:2020), ~physician_by_provider(npi = 1003000126, year = .x))

prov |> dplyr::select(rndrng_npi, rndrng_prvdr) |> 
        tidyr::unnest(cols = c(rndrng_prvdr)) |> 
        dplyr::slice_head() |> 
        tidyr::pivot_longer(cols = dplyr::everything()) |> 
        gluedown::md_table()

prov |> dplyr::select(year, totals_srvcs) |> 
        tidyr::unnest(cols = c(totals_srvcs)) |> 
        gluedown::md_table()

prov |> dplyr::select(year, bene_age) |> 
        tidyr::unnest(cols = c(bene_age)) |> 
        gluedown::md_table()

prov |> dplyr::select(year, bene_sex, bene_status) |> 
        tidyr::unnest(cols = c(bene_sex, bene_status)) |> 
        gluedown::md_table()

prov |> dplyr::select(year, bene_race) |> 
        tidyr::unnest(cols = c(bene_race)) |> 
        gluedown::md_table()

prov |> dplyr::select(year, bene_cc) |> 
     tidyr::unnest(cols = c(bene_cc)) |> 
     gluedown::md_table()

prov <- purrr::map_dfr(2013:2020, ~physician_by_provider(npi = 1003000126, year = .x))

prov_sex_count <- prov |> 
  dplyr::select(year, bene_sex) |> 
  tidyr::unnest(cols = c(bene_sex)) |> 
  dplyr::rename(female = bene_feml_cnt, 
                male = bene_male_cnt) |> 
  tidyr::pivot_longer(cols = female:male, names_to = "gender", values_to = "count")

prov_sex_pct <- prov |> 
  dplyr::select(year, bene_sex) |> 
  tidyr::unnest(cols = c(bene_sex)) |> 
  dplyr::rename(female = bene_feml_cnt, 
                male = bene_male_cnt) |> 
  dplyr::mutate(female = round((female / (female + male) * 100), 2),
                male = round((male / (female + male) * 100), 2)) |> 
  tidyr::pivot_longer(cols = female:male, names_to = "gender", values_to = "percent")

prov_sex <- dplyr::left_join(prov_sex_count, prov_sex_pct, by = dplyr::join_by(year, gender)) |> 
  dplyr::mutate(gender = forcats::as_factor(gender),
                year = forcats::as_factor(year))

py1 <- apyramid::age_pyramid(prov_sex, 
            age_group = year, 
            split_by = gender, 
            count = count,
            pyramid = TRUE)

py1 + ggplot2::labs(title = "Fisher's *Iris* data set",
       subtitle = "Demonstrating the TDC theme for ggplot2",
       x = "The x axis", y = "The y axis",
       caption = "Fisher's **Iris** data set") +
  tdcthemes::style_tdc(legend = TRUE) +
  tdcthemes::scale_fill_tdc()

prov_age <- prov |> 
  dplyr::select(year, bene_age) |> 
  tidyr::unnest(cols = c(bene_age)) |> 
  dplyr::select(-bene_avg_age) |> 
  dplyr::rename("<65" = bene_age_lt_65_cnt,
                "65-74" = bene_age_65_74_cnt,
                "75-84" = bene_age_75_84_cnt,
                ">84" = bene_age_gt_84_cnt) |> 
  tidyr::pivot_longer(cols = c("<65", "65-74", "75-84", ">84"), 
                      names_to = "age", 
                      values_to = "count") |>
  dplyr::mutate(age = forcats::as_factor(age),
                year = forcats::as_factor(year)
                )

apyramid::age_pyramid(data = prov_age, 
            age_group = year, 
            split_by = age, 
            count = count,
            pyramid = TRUE
            )
```

### Medicare Chronic Conditions APIs

```{r}
# Multiple Chronic Conditions
cc_multiple(year = 2007, geo_level = "National", demo_level = "Race")

# Specific Chronic Conditions
cc_specific(year = 2018, geo_level = "State", state_abb = "CA")
```


------------------------------------------------------------------------------

## Code of Conduct

Please note that the `provider` project is released with a [Contributor Code of Conduct](https://andrewallenbruce.github.io/provider/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.
