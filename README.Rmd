---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse  = FALSE,
  echo      = TRUE,
  message   = TRUE, 
  warning   = FALSE,
  error     = TRUE,
  comment   = "",
  dpi       = 300, 
  out.width = "100%",
  fig.path  = "man/figures/README-"
)
```

# `provider` <img src="man/figures/logo.svg" align="right" height="200" />

<!-- badges: start -->
[![R-CMD-check](https://github.com/andrewallenbruce/provider/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/andrewallenbruce/provider/actions/workflows/R-CMD-check.yaml)
[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://lifecycle.r-lib.org/articles/stages.html#experimental)
[![Project Status: WIP - Initial development is in progress, but there has not yet been a stable, usable release suitable for the public.](https://www.repostatus.org/badges/latest/wip.svg)](https://www.repostatus.org/#wip)
[![License: MIT](https://img.shields.io/badge/license-MIT-blue.svg)](https://choosealicense.com/licenses/mit/)
[![code size](https://img.shields.io/github/languages/code-size/andrewallenbruce/provider.svg)](https://github.com/andrewallenbruce/provider)
[![last commit](https://img.shields.io/github/last-commit/andrewallenbruce/provider.svg)](https://github.com/andrewallenbruce/provider/commits/main)
[![pkgdown](https://github.com/andrewallenbruce/provider/actions/workflows/pkgdown.yaml/badge.svg)](https://github.com/andrewallenbruce/provider/actions/workflows/pkgdown.yaml)
[![Codecov test coverage](https://codecov.io/gh/andrewallenbruce/provider/branch/main/graph/badge.svg)](https://app.codecov.io/gh/andrewallenbruce/provider?branch=main)
[![CodeFactor](https://www.codefactor.io/repository/github/andrewallenbruce/provider/badge)](https://www.codefactor.io/repository/github/andrewallenbruce/provider)
![GitHub milestone](https://img.shields.io/github/milestones/progress/andrewallenbruce/provider/1?color=white&logo=milestones)
<!-- badges: end -->

> Providing easy access to [healthcare provider](https://en.wikipedia.org/wiki/Health_care_provider)-centric data through publicly available APIs & sources.
 

<br>

## Installation

You can install the development version of `provider` from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("andrewallenbruce/provider")
```
``` r
# install.packages("remotes")
remotes::install_github("andrewallenbruce/provider")
```

## Motivation

```{r echo=TRUE}
library(provider)
```

<br>

The goal of `provider` is to make the experience of accessing publicly-available Medicare provider data easier and more consistent across a variety of CMS sources.

<br>


```{r results='asis', echo=FALSE}
provider:::function_tbl() |> 
  dplyr::arrange(Function) |> 
  gluedown::md_table()
```

<br>

### Beneficiary Enrollment

```{r}
beneficiary_enrollment(year = 2020, 
                       period = "Year", 
                       level = "State", 
                       fips = "01")
```


### Chronic Conditions

```{r}
# Multiple Chronic Conditions
cc_multiple(year = 2018, 
            level = "National", 
            age_group = "All", 
            demographic = "All")

cc_multiple(year = 2018, 
            level = "State", 
            sublevel = "Alabama", 
            age_group = "All", 
            demographic = "All")

cc_multiple(year = 2018, 
            level = "County", 
            sublevel = "Alabama : Autauga", 
            fips = "01001", 
            age_group = "All", 
            demographic = "All")
```


```{r}
# Specific Chronic Conditions
cc_specific(year = 2018, 
            level = "State", 
            sublevel = "California", 
            demographic = "All")

cc_specific(year = 2011, 
            level = "County", 
            fips = "01001")
```

### Doctors and Clinicians

```{r}
doctors_and_clinicians(npi = 1720081441)
doctors_and_clinicians(npi = 1407263999)
doctors_and_clinicians(school = "NEW YORK UNIVERSITY SCHOOL OF MEDICINE", 
                       grad_year = 2000, 
                       state = "FL")
```

### Facility Affiliations

```{r}
facility_affiliations(npi = 10030195634)
facility_affiliations(facility_ccn = "060004")
facility_affiliations(parent_ccn = 670055)
```


### Hospital Enrollments

```{r}
hospital_enrollment(facility_ccn = "060004")
hospital_enrollment(state = "GA", city = "VALDOSTA")
hospital_enrollment(enroll_state = "GA")
hospital_enrollment(enroll_id = "O20030404000017")
```


### Missing Contact Information

```{r}
missing_information(npi = 1144224569)
missing_information(npi = 11111122222)
```

### NPI Registry

```{r}
nppes_npi(npi = 13164059391)
nppes_npi(npi = "155836427a")
nppes_npi(1720081442)
nppes_npi(1710983663) 
nppes_npi(city = "Valdosta", org_name = "AIRPORT CLINIC INC")
nppes_npi(last_name = "Smith", purpose_name = "AO", city = "Atlanta")
nppes_npi(last_name = "Smith", purpose_name = "Accounts", city = "Atlanta")
```


```{r}
provider_enrollment(specialty_code = "00-17", state = "GA") |> 
  dplyr::pull(npi) |> 
  purrr::map(nppes_npi) |> 
  purrr::list_rbind()
```


### Open Payments

```{r}
open_payments(npi = 1043218118, year = 2021) |> 
  dplyr::filter(!is.na(covered)) |> 
  janitor::remove_empty(which = c("rows", "cols"))
```

### Opt-Out Affidavits

```{r}
opt_out(first_name = "David", last_name = "Smith")
```


```{r}
opt_out(specialty = "Psychiatry", 
        city = "Brooklyn", 
        state = "NY", 
        order_and_refer = FALSE)
```


```{r}
opt_out(specialty = "Tsychiatry")
```

### Order and Referring Privileges

```{r}
order_refer(npi = 1083879860)
order_refer(last_name = "Smith", 
            partb = FALSE, 
            pmd = FALSE)
```

### Pending Applications

```{r}
pending_applications(last_name = "Smith", type = "non-physician")
pending_applications(first_name = "John", type = "physician")
pending_applications(first_name = "John", type = "dentist")
pending_applications(npi = "1083879860", 
                     first_name = "Gaelic", 
                     last_name = "Garlic",
                     type = "physician")
```

### Physician & Other Practitioners

```{r}
# by Geography and Service
physician_by_geography(sublevel = "Georgia", year = 2020) |> 
  dplyr::slice_max(avg_payment, n = 10)
```


```{r}
# by Provider and Service
physician_by_service(year = 2020, npi = 1083879860)
```

```{r}
# by Provider
physician_by_provider(npi = 1083879860, year = 2020)
```

### Provider Enrollment

```{r}
provider_enrollment(npi = 1083879860)
```


```{r}
provider_enrollment(specialty_code = "00-17", state = "GA") # GA RHCs
```

### Revalidation Lists

```{r}
# Revalidation Due Date List
revalidation_date(npi = 1710912209)
```


```{r}
# Revalidation Reassignment List
revalidation_reassign(npi = 1710912209)
```


```{r}
# Revalidation Clinic Group Practice Reassignment
revalidation_group(npi = 1710912209)
```


```{r}
revalidation_group(enroll_id_group = "O20080205000002")
```

### Taxonomy Crosswalk

```{r}
taxonomy_crosswalk(specialty_desc = "Rehabilitation Agency")
taxonomy_crosswalk(specialty_code = "B4[14]")
taxonomy_crosswalk(specialty_code = "8")
taxonomy_crosswalk(taxonomy_code = "207Q00000X")
# taxonomy_crosswalk() |> 
#   dplyr::full_join(nucc_taxonomy_230, 
#   dplyr::join_by(taxonomy_code == code))
```


```{r eval=FALSE, echo=FALSE}
#purrr::map_dfr(2013:2020, ~physician_by_service(npi = 1003000126, year = .x))

srvcs <- provider::physician_by_service(npi = 1003000126, year = 2020) |> 
         tidyr::unnest(cols = c(rndrng_prvdr, totals_srvcs, hcpcs, averages))

ind <- srvcs |> 
  dplyr::mutate(level = "Individual") |> 
  dplyr::select(year, level, tot_benes:tot_srvcs, hcpcs_cd, 
                avg_sbmtd_chrg:avg_mdcr_pymt_amt) |> 
  dplyr::arrange(dplyr::desc(year), dplyr::desc(tot_srvcs))

state <- purrr::map_dfr(srvcs$hcpcs_cd, ~physician_by_geography(geo_desc = "Maryland", year = 2020, hcpcs_code = .x))

state <- state |> 
  dplyr::filter(place_of_srvc == "F") |>  
  dplyr::select(year, level = rndrng_prvdr_geo_lvl, tot_benes:tot_srvcs, hcpcs_cd, 
                avg_sbmtd_chrg:avg_mdcr_pymt_amt)

nat <- purrr::map_dfr(srvcs$hcpcs_cd, ~physician_by_geography(geo_level = "National", year = 2020, hcpcs_code = .x))

nat <- nat |> 
  dplyr::filter(place_of_srvc == "F") |>  
  dplyr::select(year, 
                level = rndrng_prvdr_geo_desc,
                tot_benes:tot_srvcs,
                hcpcs_cd, 
                avg_sbmtd_chrg:avg_mdcr_pymt_amt) |> 
  dplyr::arrange(dplyr::desc(year), dplyr::desc(tot_srvcs))

ind_lng <- ind |> 
  dplyr::select(!c(year)) |> 
  tidyr::pivot_longer(!c(level, hcpcs_cd)) |> 
  dplyr::mutate(value = round(value, 2))

st_lng <- state |> 
  dplyr::select(!c(year)) |> 
  tidyr::pivot_longer(!c(level, hcpcs_cd)) |> 
  dplyr::mutate(value = round(value, 2))

nat_lng <- nat |> 
  dplyr::select(!c(year)) |> 
  tidyr::pivot_longer(!c(level, hcpcs_cd)) |> 
  dplyr::mutate(value = round(value, 2))

join_2020 <- dplyr::full_join(ind_lng, st_lng, by = c("hcpcs_cd", "name", "level", "value")) |> 
  dplyr::full_join(nat_lng, by = c("hcpcs_cd", "name", "level", "value")) |> 
  dplyr::arrange(hcpcs_cd, name)

join_2020 |> 
  dplyr::filter(name == "avg_sbmtd_chrg") |> 
  tidyr::pivot_wider(names_from = level, 
                     names_glue = "{level}_avg_charge", 
                     values_from = value) |> 
  dplyr::select(!c(name)) |> 
  gluedown::md_table()

join_2020 |> 
  dplyr::filter(name == "avg_mdcr_alowd_amt") |> 
  tidyr::pivot_wider(names_from = level, 
                     names_glue = "{level}_avg_allowed", 
                     values_from = value) |> 
  dplyr::select(!c(name)) |> 
  gluedown::md_table()

join_2020 |> 
  dplyr::filter(name == "avg_mdcr_pymt_amt") |> 
  tidyr::pivot_wider(names_from = level, 
                     names_glue = "{level}_avg_pymt", 
                     values_from = value) |> 
  dplyr::select(!c(name)) |> 
  gluedown::md_table()
```

```{r eval=FALSE, echo=FALSE}
prov <- purrr::map_dfr(as.character(2013:2020), ~physician_by_provider(npi = 1003000126, year = .x))

prov |> dplyr::select(rndrng_npi, rndrng_prvdr) |> 
        tidyr::unnest(cols = c(rndrng_prvdr)) |> 
        dplyr::slice_head() |> 
        tidyr::pivot_longer(cols = dplyr::everything()) |> 
        gluedown::md_table()

prov |> dplyr::select(year, totals_srvcs) |> 
        tidyr::unnest(cols = c(totals_srvcs)) |> 
        gluedown::md_table()

prov |> dplyr::select(year, bene_age) |> 
        tidyr::unnest(cols = c(bene_age)) |> 
        gluedown::md_table()

prov |> dplyr::select(year, bene_sex, bene_status) |> 
        tidyr::unnest(cols = c(bene_sex, bene_status)) |> 
        gluedown::md_table()

prov |> dplyr::select(year, bene_race) |> 
        tidyr::unnest(cols = c(bene_race)) |> 
        gluedown::md_table()

prov |> dplyr::select(year, bene_cc) |> 
     tidyr::unnest(cols = c(bene_cc)) |> 
     gluedown::md_table()

prov <- purrr::map_dfr(2013:2020, ~physician_by_provider(npi = 1003000126, year = .x))

prov_sex_count <- prov |> 
  dplyr::select(year, bene_sex) |> 
  tidyr::unnest(cols = c(bene_sex)) |> 
  dplyr::rename(female = bene_feml_cnt, 
                male = bene_male_cnt) |> 
  tidyr::pivot_longer(cols = female:male, names_to = "gender", values_to = "count")

prov_sex_pct <- prov |> 
  dplyr::select(year, bene_sex) |> 
  tidyr::unnest(cols = c(bene_sex)) |> 
  dplyr::rename(female = bene_feml_cnt, 
                male = bene_male_cnt) |> 
  dplyr::mutate(female = round((female / (female + male) * 100), 2),
                male = round((male / (female + male) * 100), 2)) |> 
  tidyr::pivot_longer(cols = female:male, names_to = "gender", values_to = "percent")

prov_sex <- dplyr::left_join(prov_sex_count, prov_sex_pct, by = dplyr::join_by(year, gender)) |> 
  dplyr::mutate(gender = forcats::as_factor(gender),
                year = forcats::as_factor(year))

py1 <- apyramid::age_pyramid(prov_sex, 
            age_group = year, 
            split_by = gender, 
            count = count,
            pyramid = TRUE)

py1 + ggplot2::labs(title = "Fisher's *Iris* data set",
       subtitle = "Demonstrating the TDC theme for ggplot2",
       x = "The x axis", y = "The y axis",
       caption = "Fisher's **Iris** data set") +
  tdcthemes::style_tdc(legend = TRUE) +
  tdcthemes::scale_fill_tdc()

prov_age <- prov |> 
  dplyr::select(year, bene_age) |> 
  tidyr::unnest(cols = c(bene_age)) |> 
  dplyr::select(-bene_avg_age) |> 
  dplyr::rename("<65" = bene_age_lt_65_cnt,
                "65-74" = bene_age_65_74_cnt,
                "75-84" = bene_age_75_84_cnt,
                ">84" = bene_age_gt_84_cnt) |> 
  tidyr::pivot_longer(cols = c("<65", "65-74", "75-84", ">84"), 
                      names_to = "age", 
                      values_to = "count") |>
  dplyr::mutate(age = forcats::as_factor(age),
                year = forcats::as_factor(year)
                )

apyramid::age_pyramid(data = prov_age, 
            age_group = year, 
            split_by = age, 
            count = count,
            pyramid = TRUE
            )
```

------------------------------------------------------------------------------

## Code of Conduct

Please note that the `provider` project is released with a [Contributor Code of Conduct](https://andrewallenbruce.github.io/provider/CODE_OF_CONDUCT.html). By contributing to this project, you agree to abide by its terms.
